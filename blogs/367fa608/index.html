<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#5698c3"><meta name="author" content="语轻星子"><meta name="copyright" content="语轻星子"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Serverless+vue3+eggsjs 无人点餐项目 | 轻语馆</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#5698c3"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"xxcijmz.top","root":"/","title":"轻语馆","version":"1.6.2","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"algolia":{"appID":"I6Q6TFSWKC","apiKey":"8299a265813c86a465cc32755761abc9","indexName":"blogs","hits":{"per_page":10}}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="stylesheet" href="/css/content.css"><meta name="description" content="Serverless 基础部分Serverless 架构介绍​    Serverless 又名无服务器，所谓无服务器并非是说不需要依赖和依靠服务器等资源，而是开发者再也不用过多考虑服务器的问题，可以更专注在产品代码上，狭义的 Serverless 是 Fass 和 Bass 组成。 传统的高并发架构 与 Serverless 架构的区别传统：首先要采购服务器，然后配置服务器，确认哪些服务器作为">
<meta property="og:type" content="article">
<meta property="og:title" content="Serverless+vue3+eggsjs 无人点餐项目">
<meta property="og:url" content="https://xxcijmz.top/blogs/367fa608/index.html">
<meta property="og:site_name" content="轻语馆">
<meta property="og:description" content="Serverless 基础部分Serverless 架构介绍​    Serverless 又名无服务器，所谓无服务器并非是说不需要依赖和依靠服务器等资源，而是开发者再也不用过多考虑服务器的问题，可以更专注在产品代码上，狭义的 Serverless 是 Fass 和 Bass 组成。 传统的高并发架构 与 Serverless 架构的区别传统：首先要采购服务器，然后配置服务器，确认哪些服务器作为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/1.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/2.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/3.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/5.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/4.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/6.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/7.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/8.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/9.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/10.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/11.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/12.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/13.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/14.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/15.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/22.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/23.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/16.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/17.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/18.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/19.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/20.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/21.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/24.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/25.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/26.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/27.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/28.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/29.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/30.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/31.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/32.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/33.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/34.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/35.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/36.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/37.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/38.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/39.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/40.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/41.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/42.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/43.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/44.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/45.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/46.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/115.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/116.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/117.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/118.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/119.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/120.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/122.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/123.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/47.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/48.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/49.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/511.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/50.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/51.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/52.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/53.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/56.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/54.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/55.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/57.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/58.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/59.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/60.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/61.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/62.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/63.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/64.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/65.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/66.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/67.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/68.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/69.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/70.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/71.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/72.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/367fa608/73.jpg">
<meta property="article:published_time" content="2021-11-06T08:07:26.000Z">
<meta property="article:modified_time" content="2021-11-18T13:34:16.057Z">
<meta property="article:author" content="语轻星子">
<meta property="article:tag" content="eggjs">
<meta property="article:tag" content="serverless">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xxcijmz.top/blogs/367fa608/1.jpg"><script src="/js/ui/mode.js"></script></head><body><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="语轻星子"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/xxc-yqxz/xxc-yqxz.github.io/images/avatar.jpg" alt="语轻星子"></a><div class="site-author-name"><a href="/about/">语轻星子</a></div><span class="site-name">轻语馆</span><sub class="site-subtitle">我也会加油，所以你也要加油，这是约定</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">34</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">9</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://github.com/xxc-yqxz/xxc-yqxz.github.io" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=894043590&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=1379764422" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/269921139" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Serverless-%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86"><span class="toc-number">1.</span> <span class="toc-text">Serverless 基础部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">Serverless 架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84-%E4%B8%8E-Serverless-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.1.</span> <span class="toc-text">传统的高并发架构 与 Serverless 架构的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.2.</span> <span class="toc-text">相关概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%A8%A1%E5%BC%8F%E5%92%8C-ServerLess-%E6%A8%A1%E5%BC%8F%E4%B8%8B%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E4%B8%8A%E7%BA%BF%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">传统模式和 ServerLess 模式下项目开发上线流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-%E5%92%8C-ServerFul-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.4.</span> <span class="toc-text">Serverless 和 ServerFul 架构的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-%E7%9A%84%E8%83%BD%E5%8A%9B"><span class="toc-number">1.1.5.</span> <span class="toc-text">Serverless 的能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.6.</span> <span class="toc-text">一个问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-Serverless-%E5%BA%94%E7%94%A8"><span class="toc-number">1.1.7.</span> <span class="toc-text">部署 Serverless 应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-%E7%BB%84%E6%88%90%E5%8F%8A%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">Serverless 组成及开发流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-%E7%BB%84%E6%88%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">Serverless 组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%91%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">云函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-Framework"><span class="toc-number">1.3.</span> <span class="toc-text">Serverless Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-Framework-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">Serverless Framework 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebCli-%E4%B8%AD%E9%80%9A%E8%BF%87%E5%BA%94%E7%94%A8%E6%A8%A1%E6%9D%BF%E5%88%9B%E5%BB%BA%E4%BA%91%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">WebCli 中通过应用模板创建云函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VsCode%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6%E5%88%9B%E5%BB%BA%E7%BC%96%E5%86%99%E4%BA%91%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">VsCode中使用插件创建编写云函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-Cli-%E5%88%9B%E5%BB%BA%E7%BC%96%E5%86%99%E5%BA%94%E7%94%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">Serverless Cli 创建编写应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-%E4%B8%AD-%E9%83%A8%E7%BD%B2-express%E3%80%81koa%E3%80%81egg-%E9%A1%B9%E7%9B%AE%E3%80%81%E9%85%8D%E7%BD%AE%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E3%80%81%E5%AE%89%E8%A3%85%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.</span> <span class="toc-text">Serverless 中 部署 express、koa、egg 项目、配置静态资源、安装项目依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#express"><span class="toc-number">1.4.1.</span> <span class="toc-text">express</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#koa"><span class="toc-number">1.4.2.</span> <span class="toc-text">koa</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#egg"><span class="toc-number">1.4.3.</span> <span class="toc-text">egg</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-%E4%B8%AD%E9%83%A8%E7%BD%B2-Vue%E3%80%81React%E3%80%81Angular-%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.5.</span> <span class="toc-text">Serverless 中部署 Vue、React、Angular 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue"><span class="toc-number">1.5.1.</span> <span class="toc-text">Vue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#React"><span class="toc-number">1.5.2.</span> <span class="toc-text">React</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Angular"><span class="toc-number">1.5.3.</span> <span class="toc-text">Angular</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-%E4%B8%AD%E4%BD%BF%E7%94%A8-Nodejs-%E6%93%8D%E4%BD%9C-Mysql%E3%80%81-Mongodb-%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%81%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE-VPC-%E7%A7%81%E6%9C%89%E7%BD%91%E7%BB%9C"><span class="toc-number">1.6.</span> <span class="toc-text">Serverless 中使用 Nodejs 操作 Mysql、 Mongodb 数据库、以及配置 VPC 私有网络</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless-BaaS-%E5%AF%B9%E8%B1%A1%E4%BA%91%E5%AD%98%E5%82%A8-Cos-%E4%BB%8B%E7%BB%8D%E3%80%81-Nodejs-%E6%93%8D%E4%BD%9C-Cos%E3%80%81Express-%E5%9C%A8-Serverless-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E5%88%B0-Cos-%E4%B8%AD"><span class="toc-number">1.7.</span> <span class="toc-text">Serverless BaaS 对象云存储 Cos 介绍、 Nodejs 操作 Cos、Express 在 Serverless 中实现图片上传到 Cos 中</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BA%91%E5%AD%98%E5%82%A8-Cos-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.1.</span> <span class="toc-text">对象云存储 Cos 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nodejs-%E6%93%8D%E4%BD%9C-COS"><span class="toc-number">1.7.2.</span> <span class="toc-text">Nodejs 操作 COS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Express-%E5%9C%A8-Serverless-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.7.3.</span> <span class="toc-text">Express 在 Serverless 中实现图片上传</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serverless%E3%80%81Cos%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E4%BB%A5%E5%8F%8Aserverless%E4%B8%AD%E9%85%8D%E7%BD%AEhttps%E8%AE%BF%E9%97%AE"><span class="toc-number">1.8.</span> <span class="toc-text">Serverless、Cos中配置域名访问以及serverless中配置https访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serverless-%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">1.8.1.</span> <span class="toc-text">Serverless 应用配置域名访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7-SSL-%E8%AF%81%E4%B9%A6"><span class="toc-number">1.8.2.</span> <span class="toc-text">申请 SSL 证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cos%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">1.8.3.</span> <span class="toc-text">cos中配置域名访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#eggjs-%E5%9F%BA%E7%A1%80%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text">eggjs 基础部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">eggjs 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%81%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83%E3%80%81%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.2.</span> <span class="toc-text">eggjs 快速入门、搭建环境、创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E3%80%81%E8%B7%AF%E7%94%B1%E5%99%A8%E3%80%81%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">eggjs 目录结构、路由器、控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E8%B7%AF%E7%94%B1%E4%BC%A0%E5%8F%82%E3%80%81%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E3%80%81%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">2.4.</span> <span class="toc-text">eggjs 路由传参、模板引擎、静态资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E6%9C%8D%E5%8A%A1-service-%E8%B0%83%E7%94%A8%E3%80%81config-%E9%85%8D%E7%BD%AE%E3%80%81%E5%8F%8Athis%E5%86%85%E5%AE%B9"><span class="toc-number">2.5.</span> <span class="toc-text">eggjs 服务(service) 调用、config 配置、及this内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%88%AC%E8%99%AB"><span class="toc-number">2.6.</span> <span class="toc-text">eggjs 实现简单爬虫</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E6%A1%86%E6%9E%B6%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.</span> <span class="toc-text">eggjs 框架扩展配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Application"><span class="toc-number">2.7.1.</span> <span class="toc-text">Application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Context"><span class="toc-number">2.7.2.</span> <span class="toc-text">Context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Helper"><span class="toc-number">2.7.3.</span> <span class="toc-text">Helper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request"><span class="toc-number">2.7.4.</span> <span class="toc-text">Request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Response"><span class="toc-number">2.7.5.</span> <span class="toc-text">Response</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.8.</span> <span class="toc-text">eggjs 中间件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.8.1.</span> <span class="toc-text">定义中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%9F%9F%E5%90%8D%E7%A6%81%E7%94%A8"><span class="toc-number">2.8.2.</span> <span class="toc-text">使用中间件进行域名禁用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eggjs-Post-%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E3%80%81Egg-js-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6-CSRF-%E7%9A%84%E9%98%B2%E8%8C%83%E3%80%81%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">2.9.</span> <span class="toc-text">eggjs Post 提交数据、Egg.js 安全机制 CSRF 的防范、以及配置模板全局变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#egg-js-%E4%B8%AD-Cookie-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.10.</span> <span class="toc-text">egg.js 中 Cookie 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.10.1.</span> <span class="toc-text">Cookie 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eggjs-%E4%B8%AD-cookie-%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%92%8C%E8%8E%B7%E5%8F%96"><span class="toc-number">2.10.2.</span> <span class="toc-text">eggjs 中 cookie 的设置和获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eggjs-%E4%B8%AD-cookie-%E7%9A%84%E5%8F%82%E6%95%B0-options"><span class="toc-number">2.10.3.</span> <span class="toc-text">eggjs 中 cookie 的参数 options</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-js-%E4%B8%AD%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%96%87-Cookie"><span class="toc-number">2.10.4.</span> <span class="toc-text">egg.js 中设置中文 Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%85%E9%99%A4-Cookie"><span class="toc-number">2.10.5.</span> <span class="toc-text">清除 Cookie</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#egg-js-%E4%B8%AD-Session-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.11.</span> <span class="toc-text">egg.js 中 Session 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.11.1.</span> <span class="toc-text">Session 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eggjs-%E4%B8%AD-session-%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%92%8C%E8%8E%B7%E5%8F%96"><span class="toc-number">2.11.2.</span> <span class="toc-text">eggjs 中 session 的设置和获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-js-%E4%B8%AD-%E9%85%8D%E7%BD%AEsession"><span class="toc-number">2.11.3.</span> <span class="toc-text">egg.js 中 配置session</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#router-js-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%81%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6%E3%80%81Egg-%E4%B8%AD%E4%BD%BF%E7%94%A8-Koa-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.12.</span> <span class="toc-text">router.js 中使用中间件、框架默认中间件、Egg 中使用 Koa 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.12.1.</span> <span class="toc-text">全局中间件配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#router-js-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.12.2.</span> <span class="toc-text">router.js 中使用中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.12.3.</span> <span class="toc-text">配置框架默认中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Egg-%E4%B8%AD%E4%BD%BF%E7%94%A8-Koa-%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88%E6%A0%87%E5%87%86%EF%BC%89"><span class="toc-number">2.12.4.</span> <span class="toc-text">Egg 中使用 Koa 中间件（标准）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Egg-%E4%B8%AD%E4%BD%BF%E7%94%A8-Koa-%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88%E9%9D%9E%E6%A0%87%E5%87%86%EF%BC%89"><span class="toc-number">2.12.5.</span> <span class="toc-text">Egg 中使用 Koa 中间件（非标准）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.13.</span> <span class="toc-text">中间件的通用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#enable"><span class="toc-number">2.13.1.</span> <span class="toc-text">enable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match-%E5%92%8C-ignore"><span class="toc-number">2.13.2.</span> <span class="toc-text">match 和 ignore</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.14.</span> <span class="toc-text">使用中间件实现权限校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E5%87%A0%E7%A7%8D%E5%86%99%E6%B3%95%E3%80%81%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E3%80%81%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84%EF%BC%88%E8%B7%AF%E7%94%B1%E6%98%A0%E5%B0%84%EF%BC%89"><span class="toc-number">2.15.</span> <span class="toc-text">路由的几种写法、路由重定向、路由分组（路由映射）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E5%87%A0%E7%A7%8D%E5%86%99%E6%B3%95"><span class="toc-number">2.15.1.</span> <span class="toc-text">路由的几种写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">2.15.2.</span> <span class="toc-text">路由的重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">2.15.2.1.</span> <span class="toc-text">外部重定向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">2.15.2.2.</span> <span class="toc-text">内部重定向</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="toc-number">2.15.3.</span> <span class="toc-text">路由分组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E5%9F%BA%E7%B1%BBBaseController%E3%80%81%E6%8E%A7%E5%88%B6%E5%99%A8%E5%85%BC%E5%AE%B9%E5%86%99%E6%B3%95"><span class="toc-number">2.16.</span> <span class="toc-text">控制器基类BaseController、控制器兼容写法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#egg-js-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.17.</span> <span class="toc-text">egg.js 定时任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%BB%93%E5%90%88-egg-curl-%E5%8F%8A-cheerio-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E7%9B%91%E6%8E%A7"><span class="toc-number">2.18.</span> <span class="toc-text">定时任务结合 egg.curl 及 cheerio 模块实现网站监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E5%AE%89%E8%A3%85-%E5%8F%8A-Navicat-%E4%BD%BF%E7%94%A8"><span class="toc-number">2.19.</span> <span class="toc-text">mysql安装 及 Navicat 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql-%E5%AE%89%E8%A3%85"><span class="toc-number">2.19.1.</span> <span class="toc-text">Mysql 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Navicat-%E4%BD%BF%E7%94%A8"><span class="toc-number">2.19.2.</span> <span class="toc-text">Navicat 使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84%E5%A2%9E%E3%80%81%E5%88%A0%E3%80%81%E6%94%B9%E3%80%81%E6%9F%A5"><span class="toc-number">2.20.</span> <span class="toc-text">mysql数据库表的增、删、改、查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E5%AD%97%E6%AE%B5%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.21.</span> <span class="toc-text">mysql 字段常用数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.22.</span> <span class="toc-text">mysql 查询语句详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WHERE-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%B8%B8%E7%94%A8%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">2.22.1.</span> <span class="toc-text">WHERE 表达式的常用运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql-%E5%88%86%E7%BB%84%E5%87%BD%E6%95%B0"><span class="toc-number">2.22.2.</span> <span class="toc-text">Mysql 分组函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql-%E5%88%AB%E5%90%8D"><span class="toc-number">2.22.3.</span> <span class="toc-text">Mysql 别名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E8%A1%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E5%85%B3%E7%B3%BB%E5%8F%8A%E6%9F%A5%E8%AF%A2%E8%BF%9B%E9%98%B6"><span class="toc-number">2.23.</span> <span class="toc-text">mysql 表的三种关系及查询进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">2.23.1.</span> <span class="toc-text">一对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">2.23.2.</span> <span class="toc-text">一对多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">2.23.3.</span> <span class="toc-text">多对多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql-%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF%E8%BF%9E%E6%8E%A5%E3%80%81%E5%86%85%E8%BF%9E%E6%8E%A5%E3%80%81%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5%E3%80%81%E5%8F%B3%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.23.4.</span> <span class="toc-text">Mysql 笛卡尔积连接、内连接、左外连接、右外连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E8%A1%A8%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-number">2.24.</span> <span class="toc-text">mysql 表的索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E4%BA%8B%E5%8A%A1%E4%B8%8E%E9%94%81%E5%AE%9A"><span class="toc-number">2.25.</span> <span class="toc-text">mysql 事务与锁定</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.25.1.</span> <span class="toc-text">mysql 事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-%E9%94%81"><span class="toc-number">2.25.2.</span> <span class="toc-text">mysql 锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#egg-js%E4%B8%AD%E4%BD%BF%E7%94%A8egg-mysql%E6%93%8D%E4%BD%9Cmysql%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.26.</span> <span class="toc-text">egg.js中使用egg-mysql操作mysql数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#egg-js-%E4%B8%AD%E4%BD%BF%E7%94%A8-Sequelize-ORM-%E6%A1%86%E6%9E%B6-%E6%93%8D%E4%BD%9C-%E6%95%B0%E6%8D%AE%E5%BA%93-%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">2.27.</span> <span class="toc-text">egg.js 中使用 Sequelize ORM 框架 操作 数据库 - 增删改查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Egg%E4%B8%AD%E4%BD%BF%E7%94%A8Sequelize-ORM%E6%A1%86%E6%9E%B6%E6%93%8D%E4%BD%9CMysql-%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.28.</span> <span class="toc-text">Egg中使用Sequelize ORM框架操作Mysql-进行关联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%B9-1-hasOne-%E5%92%8C-belongsTo"><span class="toc-number">2.28.1.</span> <span class="toc-text">1 对 1 (hasOne 和 belongsTo)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%B9-%E5%A4%9A-hasMany-%E5%92%8C-belongsTo"><span class="toc-number">2.28.2.</span> <span class="toc-text">1 对 多 (hasMany 和 belongsTo)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A-%EF%BC%88belongsToMany"><span class="toc-number">2.28.3.</span> <span class="toc-text">多对多 （belongsToMany)</span></a></li></ol></li></ol></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/JS/" style="font-size: 26.4px; color: #8cbbd1">JS</a> <a href="/tags/Vue/" style="font-size: 30px; color: #8abcd1">Vue</a> <a href="/tags/eggjs/" style="font-size: 19.2px; color: #8fb8d0">eggjs</a> <a href="/tags/serverless/" style="font-size: 19.2px; color: #8fb8d0">serverless</a> <a href="/tags/uniapp/" style="font-size: 22.8px; color: #8eb9d0">uniapp</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15.6px; color: #91b6cf">小程序</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 15.6px; color: #91b6cf">工程化</a> <a href="/tags/%E6%97%A5%E8%AE%B0/" style="font-size: 12px; color: #93b5cf">日记</a> <a href="/tags/%E6%A6%82%E5%BF%B5/" style="font-size: 22.8px; color: #8eb9d0">概念</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 12px; color: #93b5cf">部署</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://xxcijmz.top/blogs/367fa608/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="语轻星子"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="轻语馆"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Serverless+vue3+eggsjs 无人点餐项目</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-11-06 16:07:26" itemprop="dateCreated datePublished" datetime="2021-11-06T16:07:26+08:00">2021-11-06</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-11-18 21:34:16" itemprop="dateModified" datetime="2021-11-18T21:34:16+08:00">2021-11-18</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">19.8k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">84m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">项目开发</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/eggjs/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">eggjs</span></a><a class="tag-item" href="/tags/serverless/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">serverless</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#5698c3;"><h1 id="Serverless-基础部分"><a href="#Serverless-基础部分" class="headerlink" title="Serverless 基础部分"></a>Serverless 基础部分</h1><h2 id="Serverless-架构介绍"><a href="#Serverless-架构介绍" class="headerlink" title="Serverless 架构介绍"></a>Serverless 架构介绍</h2><p>​    <strong><code>Serverless</code></strong> 又名无服务器，所谓无服务器<strong>并非</strong>是说不需要依赖和依靠服务器等资源，而是开发者再也不用过多考虑服务器的问题，可以更专注在产品代码上，狭义的 <strong><code>Serverless</code></strong> 是 <strong><code>Fass</code></strong> 和 <strong><code>Bass</code></strong> 组成。</p>
<h3 id="传统的高并发架构-与-Serverless-架构的区别"><a href="#传统的高并发架构-与-Serverless-架构的区别" class="headerlink" title="传统的高并发架构 与 Serverless 架构的区别"></a>传统的高并发架构 与 Serverless 架构的区别</h3><p>传统：首先要采购服务器，然后配置服务器，确认哪些服务器作为 <strong><code>Web</code></strong> 服务器，哪些作为 <strong><code>数据库</code></strong> 服务器。然后搭建对应的环境，配置负载均衡，配置主从数据库，配置静态服务器。最后还要部署服务器。后期还要 维护服务器。</p>
<p>Serverless：开发者不需要关注服务器相关的东西，不需要关注到底要买几台服务器，也不需要关心哪些 作为 Web 服务器，哪些作为数据库服务器，更不需要关心环境的搭建与部署。开发者只需要把代码上传到 Serverless 服务器中。其内部拥有 <strong>日志服务</strong>、<strong>监控服务</strong>、<strong>高并发</strong>等。</p>
<h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><p>Serverless 又名无服务器,所谓无服务器并非是说不需要依赖和依靠服务器等资源,而是 开发者再也不用过多考虑服务器的问题,可以更专注在产品代码上。</p>
<p> Serverless 是一种软件系统架构的思想和方法，它不是软件框架、类库或者工具。它与 传统架构的不同之处在于，完全由第三方管理，由事件触发，存在于**<code>无状态</code>**（Stateless）、 **<code>暂存</code>**（可能只存在于一次调用的过程中）计算容器内。构建无服务器应用程序意味着开发者 可以专注在产品代码上，而无须管理和操作云端或本地的服务器或运行时（运行时通俗的讲 就是运行环境，比如 nodejs 环境，java 环境，php 环境）。</p>
<p>Serverless 真正做到了部署应用 无需涉及基础设施的建设，自动构建、部署和启动服务。 通俗的讲：**<code>Serverless 是构建和运行软件时不需要关心服务器的一种架构思想</code>**。老程序 员都用过虚拟主机，刚开始学 Serverless 你可以把它理解为虚拟主机的升级版本。</p>
<p>**<code>虚拟主机</code><strong>已经是快被淘汰掉的上一代产物了。云计算涌现出很多改变传统 IT 架构和运维方 式的新技术，比如虚拟机、容器、微服务，无论这些技术应用在哪些场景，降低成本、提升 效率是云服务永恒的主题。Serverless 的出现真正的解决了</strong><code>降低成本、提升效率</code>**的问题。它真正做到了弹性伸缩、高并发、按需收费、备份容灾、日志监控等。</p>
<h3 id="传统模式和-ServerLess-模式下项目开发上线流程"><a href="#传统模式和-ServerLess-模式下项目开发上线流程" class="headerlink" title="传统模式和 ServerLess 模式下项目开发上线流程"></a>传统模式和 ServerLess 模式下项目开发上线流程</h3><p><img src="/blogs/367fa608/1.jpg" loading="lazy"></p>
<h3 id="Serverless-和-ServerFul-架构的区别"><a href="#Serverless-和-ServerFul-架构的区别" class="headerlink" title="Serverless 和 ServerFul 架构的区别"></a>Serverless 和 ServerFul 架构的区别</h3><ul>
<li><p>传统的 ServerFul 架构模式</p>
<p>ServerFul 架构就是 n 台 Server 通过 网络通信 的 方式 协作在一起，也可以说 ServerFul 架构是基于 Server 和 网络通信（分布式计算） 的 软件实现架构 ， Server 可以是 虚拟机、物理机 ，以及基于硬件实现的云服务器。</p>
<p><img src="/blogs/367fa608/2.jpg" loading="lazy"></p>
</li>
<li><p>Serverless 架构模式</p>
<p>Serverless 的核心特点就是实现自动弹性伸缩和按量付费。</p>
</li>
</ul>
<p><img src="/blogs/367fa608/3.jpg" loading="lazy"></p>
<p>ServerLess 相比 ServerFul 有下面一些特点： </p>
<ul>
<li>资源分配： 在 Serverless 架构中，你不用关心应用运行的资源（比如服务配置、磁盘大 小）只提供一份代码就行。 </li>
<li>计费方式： 在 Serverless 架构中，计费方式按实际使用量计费（比如函数调用次数、运 行时长），不按传统的执行代码所需的资源计费（比如固定 CPU）。计费粒度也精确到了毫 秒级，而不是传统的小时级别。个别云厂商推出了每个月的免费额度，比如腾讯云提供了每 个月 40 万 GBs 的资源使用额度和 100 万次调用次数的免费额度。中小企业的网站访问量不 是特别大的话完全可以免费使用。 </li>
<li>弹性伸缩： Serverless 架构的弹性伸缩更自动化、更精确，可以快速根据业务并发扩容更多的实例，甚至允许缩容到零实例状态来实现零费用，对用户来说是完全无感知的。而传统 架构对服务器（虚拟机）进行扩容，虚拟机的启动速度也比较慢，需要几分钟甚至更久。</li>
</ul>
<h3 id="Serverless-的能力"><a href="#Serverless-的能力" class="headerlink" title="Serverless 的能力"></a>Serverless 的能力</h3><ul>
<li><p>计算能力</p>
<ul>
<li><p>资源按需分配，无需申请资原 </p>
</li>
<li><p>Mwm：租户级别强镜离 Docker：进程级别隔离 Mwm+Docker </p>
</li>
<li><p>轻量级资源毫秒级启动 </p>
</li>
<li><p>实时扩容，阶梯缩容 </p>
</li>
<li><p>按需收费</p>
</li>
</ul>
</li>
<li><p>系统运维能力</p>
<ul>
<li><p>性能保障</p>
<ul>
<li>(1) 整个链路耗时毫秒级内,并支持 VPC 内网访问</li>
</ul>
</li>
<li><p>安全保障</p>
<ul>
<li>(1) 资源对用户不可见,安全由腾讯云提供专业的保障</li>
<li>(2) 提供进程级和用户级安全隔离</li>
<li>(3) 访问控制管理</li>
</ul>
</li>
<li><p>自动性护缩容</p>
<ul>
<li>(1) 根据 CPU 内容网络 IO 自动扩容底层资源</li>
<li>(2) 根据请求数自动扩缩容函数实例，业务高峰期扩容，满足业务高并发需求，业务低 峰期缩容，释放资源，降低成本</li>
</ul>
</li>
<li><p>自愈能力</p>
<ul>
<li><p>(1) 每一次请求都是一个健康的实例</p>
<p>​        Serverless 中云函数被第一次调用会执行冷启动，Serverless 中云函数被多次连续调用会 执行热启动</p>
<p>​        冷启动是指你在服务器中新开辟一块空间供一个函数实例运行，这个过程有点像你把这 个函数放到虚拟机里去运行，每次运行前都要先启动虚拟机加载这个函数，以前冷启动非常 耗时，但是目前云厂商已经能做到毫秒级别的冷启动，这个过程我们也不需要关心，但是需 要注意的是使用 Seesion 的时候可能会导致 Session 丢失，所以我们的 Seesion 建议保存到数 据库。 </p>
<p>​        热启动则是说如果一个云函数被持续触发，那我就先不释放这个云函数实例，下次请求 仍然由之前已经创建了的云函数实例来运行，就好比我们打开虚拟机运行完这个函数之后没 有关闭虚拟机，而是让它待机，等待下一次被重新触发调用运行，这样做的好处就是省去了 给虚拟机「开机」的一个耗时环节，缺点是要一直维持这个虚拟机的激活状态，系统开销会 大一些。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>业务运维能力</p>
<ul>
<li>工具建设：vscode 插件、WebIDE、Command Line、云 api、Sdk </li>
<li>版本管理、操作管理等 </li>
<li>故障排查 </li>
<li>监控报警</li>
</ul>
</li>
</ul>
<h3 id="一个问题"><a href="#一个问题" class="headerlink" title="一个问题"></a>一个问题</h3><blockquote>
<p>阿里云 腾讯云 华为云我们为什么选择了腾讯云？</p>
</blockquote>
<p>1、微信小程序的云开发就是基于腾讯云，选择腾讯云更方便和小程序对接 </p>
<p>2、腾讯云在 serverless 方面相比其他厂商支持更好一些 </p>
<p>3、腾讯云的技术在线客服非常棒 </p>
<p>4、腾讯云和 serverless 合作在腾讯云中集成了 serverless Framework 让我们可以 用我们喜欢的框架开发 serverless 应用。也可以让我们快速部署老项目。</p>
<p>5、价格更便宜</p>
<h3 id="部署-Serverless-应用"><a href="#部署-Serverless-应用" class="headerlink" title="部署 Serverless 应用"></a>部署 Serverless 应用</h3><blockquote>
<p>主要介绍的是如何通过 Serverless Framework 提供的云函数 SCF 组件快速创建与部署一个云函数项目。</p>
<p>Serverless Framework 会将项目快速部署到腾讯云 Serverless 平台，因此在部 署前，请确认您已经 注册腾讯云账号 并完成 实名认证。</p>
</blockquote>
<ol>
<li><p>全局安装 serverless</p>
<pre class="language-text" data-language="text"><code class="language-text">npm install -g serverless
serverless -v</code></pre></li>
<li><p>通过 serverless 命令创建项目</p>
</li>
</ol>
<p><img src="/blogs/367fa608/5.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/4.jpg" loading="lazy"></p>
<ol start="3">
<li>此后我们便可以在 腾讯云的控制台中看到部署好的项目，并可在命令行中看到本项目的 url 地址：</li>
</ol>
<p><img src="/blogs/367fa608/6.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/7.jpg" loading="lazy"></p>
<h2 id="Serverless-组成及开发流程"><a href="#Serverless-组成及开发流程" class="headerlink" title="Serverless 组成及开发流程"></a>Serverless 组成及开发流程</h2><h3 id="Serverless-组成"><a href="#Serverless-组成" class="headerlink" title="Serverless 组成"></a>Serverless 组成</h3><p>广义的 Serverless 更多是指一种技术理念：Serverless 是构建和运行软件时不需要关心服务器的一种架构思想。刚开始学 Serverless 你可以把它理解为虚拟主机的升级版本。 </p>
<p>狭义的 Serverless 是指现阶段主流的技术实现：狭义的 Serverless 是 FaaS 和 BaaS 组成</p>
<h3 id="云函数"><a href="#云函数" class="headerlink" title="云函数"></a>云函数</h3><p>云函数可以在腾讯云控制台进行配置操作（前提是注册了腾讯云账号并实名认证了）。之前使用的 Serverless Framework 本质也是基于云函数的。</p>
<p><img src="/blogs/367fa608/8.jpg" loading="lazy"></p>
<p>进入云函数页面后，首先我们可以看到当前账户的一些云函数信息：（函数数量、应用数量、本月调用数、本月资源使用量、本月出流量【表示访问外部网站资源的流量】等）。同时可以看到，腾讯云每月会为我们提供相应的免费资源使用量。</p>
<p><img src="/blogs/367fa608/9.jpg" loading="lazy"></p>
<p>新建云函数前，首先要注意上方的 <strong><code>地域</code></strong> 及 **<code>命名管理空间</code>**。下方表格中只会展示对应 地域 及命名管理空间的 云函数。</p>
<p>同时，我们可以通过旁边的设置图标来新增命名空间。</p>
<p><img src="/blogs/367fa608/10.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/11.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/12.jpg" loading="lazy"></p>
<p>当新建云函数时，可以选择模板创建（效果类似上节），含可以选择自定义创建，自定义创建时要选好对应的 <strong><code>运行环境</code></strong> 。</p>
<p><img src="/blogs/367fa608/13.jpg" loading="lazy"></p>
<p>创建完后，我们便可根据的命名空间 及 地域来观察对应的  云函数。同时我们可以点击函数名，进入对应函数管理页面。</p>
<p><img src="/blogs/367fa608/14.jpg" loading="lazy"></p>
<p>在函数管理 -&gt; 函数配置 页面中，可以点击右上角的 编辑 来修改函数配置。</p>
<p><img src="/blogs/367fa608/15.jpg" loading="lazy"></p>
<p>在函数管理 -&gt; 函数代码 页面中，我们看到平台为我们初始化的代码。而当我们修改代码后，需要点击部署，对应的修改才能生效</p>
<p><img src="/blogs/367fa608/22.jpg" loading="lazy"></p>
<p>同时我们在页面下方，将通过修改参数（此处的参数为 event ）的方式，然后点击测试，来查看函数运行的结果。</p>
<p><img src="/blogs/367fa608/23.jpg" loading="lazy"></p>
<p>当配置好函数后，我们仍然无法通过 url 地址来看到函数执行结果，这就需要我们去创建触发器来实现。</p>
<p>在函数管理下方，点击触发管理 -&gt; 创建触发器</p>
<p>注意：创建触发器时，要选中 触发方式为 API网关触发。同时关闭 **<code>集成响应</code>**（以确保云函数可以返回任意类型【不仅限于 JSON】的数据）</p>
<p><img src="/blogs/367fa608/16.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/17.jpg" loading="lazy"></p>
<p>当新建完触发器后，此时触发器提供的访问路径为腾讯云提供的，而我们可以通过点击触发器的 <strong><code>API服务名</code></strong> 来自定义域名。</p>
<p><img src="/blogs/367fa608/18.jpg" loading="lazy"></p>
<p>最后我们再来了解一下 <strong><code>层</code></strong> 的概念，层为 云函数 共用的一些模块，我们可以在其中新建层，通过本地上传 zip 包等方式，来上传一些函数需要的包。</p>
<p><img src="/blogs/367fa608/19.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/20.jpg" loading="lazy"></p>
<p>新建完层后，可以在函数服务中点击层管理 -&gt; 绑定，来为当前函数绑定层。</p>
<p><img src="/blogs/367fa608/21.jpg" loading="lazy"></p>
<h2 id="Serverless-Framework"><a href="#Serverless-Framework" class="headerlink" title="Serverless Framework"></a>Serverless Framework</h2><h3 id="Serverless-Framework-简介"><a href="#Serverless-Framework-简介" class="headerlink" title="Serverless Framework 简介"></a>Serverless Framework 简介</h3><p>Serverless Framework 是 Serverless 公司推出的一个开源的 Serverless 应用开发框架。 </p>
<p>Serverless Framework 是 由 Serverless Framework Plugin 和 Serverless Framework Components 组成 ：</p>
<p>Serverless Framework Plugin 实际上是一个函数的管理工具，使用这个工具，可以很轻 松的部署函数、删除函数、触发函数、查看函数信息、查看函数日志、回滚函数、查看函数 数据等。 </p>
<p>Serverless Framework Components 可以看作是一个组件集，这里面包括了很多的 Components，有基础的 Components，例如 cos、scf、apigateway 等，也有一些拓展的 Components，例如在 cos 上拓展出来的 website，可以直接部署静态网站等，还有一些框 架级的，例如 Koa，Express…</p>
<p>Serverless Framework 官网：<a target="_blank" rel="noopener" href="https://www.serverless.com/">https://www.serverless.com/</a> </p>
<p>Serverless Framework 中文网站：<a target="_blank" rel="noopener" href="https://www.serverless.com/cn">https://www.serverless.com/cn</a> </p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/serverless/serverless">https://github.com/serverless/serverless</a></p>
<h3 id="WebCli-中通过应用模板创建云函数"><a href="#WebCli-中通过应用模板创建云函数" class="headerlink" title="WebCli 中通过应用模板创建云函数"></a>WebCli 中通过应用模板创建云函数</h3><p>首先登录 腾讯云，在控制台打开 Serverless 应用中心。</p>
<p><img src="/blogs/367fa608/24.jpg" loading="lazy"></p>
<p>进入 页面后，点击 新建应用 -&gt; Web 应用，选好框架类型后，点击下一步，输入应用名、环境、地域后，点击完成。</p>
<p><img src="/blogs/367fa608/25.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/26.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/27.jpg" loading="lazy"></p>
<p>等项目部署成功后，我们便可以看到对应的 应用详情，可以点击 <strong><code>url</code></strong> 查看运行结果，或者点击函数名称查看到其 Framework 生成的对应的云函数的配置页面。我们可以在代码管理中，新增一个 路由，并点击部署</p>
<p><img src="/blogs/367fa608/28.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/29.jpg" loading="lazy"></p>
<p>部署成功后，我们便可以通过路径访问到对应路由</p>
<p><img src="/blogs/367fa608/30.jpg" loading="lazy"></p>
<p>除了生成云函数之外，Framework 还会为我们生成 函数对应的触发器：</p>
<p><img src="/blogs/367fa608/31.jpg" loading="lazy"></p>
<p>以上便是根据Webcli 创建云函数的方式，但我们可以发现，此种方式创建云函数后，我们如果想要修改代码，是比较麻烦的。下面将提出解决方案。</p>
<h3 id="VsCode中使用插件创建编写云函数"><a href="#VsCode中使用插件创建编写云函数" class="headerlink" title="VsCode中使用插件创建编写云函数"></a>VsCode中使用插件创建编写云函数</h3><p>​        Tencent Serverless Toolkit for VS Code 是腾讯云 Serverless 产品的 VS Code（Visual Studio Code）IDE 的插件。该插件可以让您更好的在本地进行 Serverless 项目开发和代码调 试，并且轻松将项目部署到云端。</p>
<p>要使用这个插件，首先得安装</p>
<p><img src="/blogs/367fa608/32.jpg" loading="lazy"></p>
<p>安装完成后，可以看到侧边栏多出了一个云端图标。点击创建一个腾讯云用户凭证。</p>
<p><img src="/blogs/367fa608/33.jpg" loading="lazy"></p>
<p>其会要求我们输入 AppId 、SecretId及 SecretKey，我们可以在 插件文档中找到对应 值的 查找网址</p>
<p><img src="/blogs/367fa608/34.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/35.jpg" loading="lazy"></p>
<p>等全部输入后，我们便可获取到云端函数，通过点击下载到本地，即可将云端函数下载到本地。</p>
<p><img src="/blogs/367fa608/36.jpg" loading="lazy"></p>
<div class="danger">


<blockquote>
<p>注意：</p>
<p>1.如果 Tencent Serverless Toolkit for VS Code 安装的是最新版，会导致 屏蔽暂不支持的web函数及镜像函数 。这时可以通过降低插件版本来解决问题。</p>
<p>2.如果有部署失败的情况发生，有可能是因为 serverless.yaml 中的handler为空。但即便添加了 handler ，提交成功后也无法 使用。</p>
</blockquote>
</div>

<p>此后，每当我们修改了 代码，便可以通过 本地函数中的上传按钮，将最新的代码上传至云端。</p>
<p><img src="/blogs/367fa608/37.jpg" loading="lazy"></p>
<p>需要注意的是：上传后的代码会自动部署，但是上传后的所有接口会显示：**<code>FunctionType不合法.</code>**，所以  <strong><code>不推荐此种用法</code></strong>  。</p>
<h3 id="Serverless-Cli-创建编写应用"><a href="#Serverless-Cli-创建编写应用" class="headerlink" title="Serverless Cli 创建编写应用"></a>Serverless Cli 创建编写应用</h3><p>关于 安装及使用Serverless Cli 来创建应用可以参考 Serverless架构介绍 -&gt;  部署 Serverless 应用一章</p>
<p>在用 Serverless Cli 创建完应用后，修改完应用后输入 <code>serverless deploy</code> 即可将应用重新部署到 云端。</p>
<p>本项目中主要使用此种写法来创建编写应用。（因为使用插件会有一些问题）</p>
<h2 id="Serverless-中-部署-express、koa、egg-项目、配置静态资源、安装项目依赖"><a href="#Serverless-中-部署-express、koa、egg-项目、配置静态资源、安装项目依赖" class="headerlink" title="Serverless 中 部署 express、koa、egg 项目、配置静态资源、安装项目依赖"></a>Serverless 中 部署 express、koa、egg 项目、配置静态资源、安装项目依赖</h2><h3 id="express"><a href="#express" class="headerlink" title="express"></a>express</h3><p>首先 使用 <code>serverless</code> 来创建 express 项目</p>
<p>创建完后，打开 项目根目录下的 <strong><code>app.js</code></strong> ，为其添加配置静态资源的 代码：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>其中 static 文件目录如下：</p>
<p><img src="/blogs/367fa608/38.jpg" loading="lazy"></p>
<p>配置完后，便可以在 根目录下的 index.html 中使用：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Serverless - Express.js<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/index.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    欢迎访问 Express.js 应用
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cloud.tencent.com/product/sls<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noopener noreferrer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      腾讯云 Serverless
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    为您提供服务
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/images/2.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p>然后在 本地运行，可以 <strong>成功</strong> 看到运行结果。</p>
<p>之后将项目通过 <strong><code>serverless deploy</code></strong> 部署到云端。部署前可以在 项目根目录的 <strong><code>serverless.yml</code></strong> 文件中的 <strong>exclude</strong> 选项中添加 node_modules 选项，但同时要在云端 编译器 中点击开启 <strong><code>自动安装依赖</code></strong></p>
<p><img src="/blogs/367fa608/39.jpg" loading="lazy"></p>
<p>此后也可以成功看到运行结果（若图片无法加载成功，请在app.js 中配置 **<code>app.binaryTypes = [&#39;*/*&#39;]</code>**，目前serverless 升级了，好像不用再配置了）。</p>
<p>接下来在 <strong><code>express</code></strong> 项目中使用 <strong><code>ejs</code></strong> 模板引擎</p>
<p>首先先进行安装：</p>
<p><strong><code>cnpm i ejs --save</code></strong></p>
<p>安裝完后，在项目中配置并使用 模板引擎</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>

<span class="token comment">// 表示将 ejs模板引擎 重命名为 html</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">,</span>ejs<span class="token punctuation">.</span>__express<span class="token punctuation">)</span>
<span class="token comment">// 注册模板引擎</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span><span class="token string">'html'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'薛昕'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>

<p>此后我们便可以在 views 文件夹下的文件中使用模板引擎。</p>
<p><strong><code>views/index.html</code></strong></p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    欢迎访问 Express.js 应用
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cloud.tencent.com/product/sls<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noopener noreferrer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      腾讯云 Serverless
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    为您提供服务
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  &lt;%=title %>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/images/2.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p>在本地运行后发现可以实现效果。</p>
<p>使用 <strong><code>serverless deploy</code></strong> 部署后发现，其在云端也可以生效（若有未生效的情况，请检查是否开启了 **<code>自动安装依赖</code>**）</p>
<h3 id="koa"><a href="#koa" class="headerlink" title="koa"></a>koa</h3><p>首先使用 serverless 新建一个 koa 项目</p>
<p>新建成功后，为其新增一个接口进行测试：</p>
<p><strong><code>app.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">...</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'xxc'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token operator">...</span></code></pre>

<p><img src="/blogs/367fa608/40.jpg" loading="lazy"></p>
<p>可以看到结果成功。之后为其配置静态目录</p>
<p>首先安装 <strong><code>koa-static</code></strong> 插件</p>
<p><strong><code>cnpm i koa-static --save</code></strong></p>
<p>然后配置 <strong><code>static</code></strong> </p>
<p><strong><code>app.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>配置完后，在 index.html 中使用：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/index.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    欢迎访问 Koa.js 应用
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cloud.tencent.com/product/sls<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>noopener noreferrer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      腾讯云 Serverless
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    为您提供服务
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/images/2.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p>可以看到效果生效。</p>
<p>本地生效后，可以使用 <strong><code>serverless deploy</code></strong> 将项目部署到云端（不知道为啥，部署的项目没有对应的 API 网关，需要我们自动去创建  -&gt; 发现原因是因为授权后未等部署完成后就退出了）。</p>
<p>可以看到云端中也可以生效。</p>
<p>然后关于在 koa 中安装使用项目依赖的方式，与express 类似，这里不做介绍。</p>
<h3 id="egg"><a href="#egg" class="headerlink" title="egg"></a>egg</h3><p>egg 框架中默认已经配置好了静态资源，我们可以直接访问。</p>
<p>使用 serverless 安装好 egg 项目后，在控制台输入 **<code>npm run dev</code>**，即可运行。</p>
<p>同时修改代码后上传前要 通过 配置忽略掉 **<code>node_modules</code>**，并在云端开启自动安装依赖。</p>
<h2 id="Serverless-中部署-Vue、React、Angular-项目"><a href="#Serverless-中部署-Vue、React、Angular-项目" class="headerlink" title="Serverless 中部署 Vue、React、Angular 项目"></a>Serverless 中部署 Vue、React、Angular 项目</h2><h3 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h3><ul>
<li><p>Serverless 生成 Vue 项目时，当我们授权完后，会将 AppId、SecretId、SecretKey 保存到 .env 文件中。之前部署的 后端项目也会。</p>
</li>
<li><p>Serverless 生成的 Vue 项目默认是 Vue2 项目。</p>
</li>
<li><p>若想部署 Vue3 项目，我们可以将Serverless 生成的 Vue 项目 中的文件除了 serverless.yml 之外全部删除，然后将 已经准备好的 Vue3 项目移动到 Serverless 生成的 Vue 项目中，进行依赖安装并运行。</p>
</li>
<li><p>确保可以运行后，在 <strong><code>serverless.yml</code></strong> 中确保 发布的 目录为 dist目录</p>
</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">inputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">src</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> ./src
    <span class="token key atrule">hook</span><span class="token punctuation">:</span> npm run build
    <span class="token key atrule">dist</span><span class="token punctuation">:</span> ./dist</code></pre>

<ul>
<li><p>然后便可以用 <strong><code>serverless deploy</code></strong> 来发布当前 vue3 项目到云端。</p>
</li>
<li><p>需要注意的是，此处的 Vue 项目 代码会被上传到 对象云存储中，而不是 云函数中。</p>
</li>
<li><p>对象云存储的 名称在 <strong><code>serverless.yml</code></strong> 中设置：</p>
</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">bucketName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>vue<span class="token punctuation">-</span>starter
  <span class="token punctuation">...</span></code></pre>

<ul>
<li>同时 <strong><code>serverless.yml</code></strong> 中还可以设置是否开启 强制 https，开启后可能会导致一些请求出现错误。我们可以在文件中直接修改，或者在云平台中进行修改</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span> https
  <span class="token punctuation">...</span></code></pre>

<p><img src="/blogs/367fa608/41.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/42.jpg" loading="lazy"></p>
<ul>
<li><p>此时还会有一个问题：在一个页面中进行刷新操作后，会导致跳转至404页面，这是因为浏览器在刷新时，会向服务器发送请求，而这个请求服务器无对应的响应资源。就会导致跳转到默认的 404 页面。而要解决这个问题，我们需要设置 error 对应的 页面为 index.html</p>
<p><img src="/blogs/367fa608/43.jpg" loading="lazy"></p>
</li>
</ul>
<h3 id="React"><a href="#React" class="headerlink" title="React"></a>React</h3><p>React 的操作基本上与 Vue  一致，故此处不做讲解</p>
<h3 id="Angular"><a href="#Angular" class="headerlink" title="Angular"></a>Angular</h3><ul>
<li>当我们使用 <strong><code>serverless</code></strong> 去新建项目时，可以看到其中没有 angular 项目，所以我们可以 通过选择 <strong><code>快速部署一个静态网站</code></strong> 后，在修改其的 <strong><code>serverless.yml</code></strong> 文件后。将已有的 angular 项目复制到项目目录中，来进行 <strong><code>serverless deploy</code></strong> 部署。</li>
<li>有一点需要注意的是：angular 中通过 npm run build 生成的目录中并不是直接包含打包文件。而是先包含了一个目录，这个目录中有打包文件。所以我们需要在 <strong><code>serverless.yml</code></strong> 的 input 的 dist 选项中进行修改。</li>
</ul>
<h2 id="Serverless-中使用-Nodejs-操作-Mysql、-Mongodb-数据库、以及配置-VPC-私有网络"><a href="#Serverless-中使用-Nodejs-操作-Mysql、-Mongodb-数据库、以及配置-VPC-私有网络" class="headerlink" title="Serverless 中使用 Nodejs 操作 Mysql、 Mongodb 数据库、以及配置 VPC 私有网络"></a>Serverless 中使用 Nodejs 操作 Mysql、 Mongodb 数据库、以及配置 VPC 私有网络</h2><p>由于云数据库要钱，待补…</p>
<h2 id="Serverless-BaaS-对象云存储-Cos-介绍、-Nodejs-操作-Cos、Express-在-Serverless-中实现图片上传到-Cos-中"><a href="#Serverless-BaaS-对象云存储-Cos-介绍、-Nodejs-操作-Cos、Express-在-Serverless-中实现图片上传到-Cos-中" class="headerlink" title="Serverless BaaS 对象云存储 Cos 介绍、 Nodejs 操作 Cos、Express 在 Serverless 中实现图片上传到 Cos 中"></a>Serverless BaaS 对象云存储 Cos 介绍、 Nodejs 操作 Cos、Express 在 Serverless 中实现图片上传到 Cos 中</h2><h3 id="对象云存储-Cos-介绍"><a href="#对象云存储-Cos-介绍" class="headerlink" title="对象云存储 Cos 介绍"></a>对象云存储 Cos 介绍</h3><p>狭义的 Serverless 是 FaaS 和 BaaS 组成</p>
<p><img src="/blogs/367fa608/44.jpg" loading="lazy"></p>
<p>对象存储（Cloud Object Storage，COS）是一种存储海量文件的分布式存储服务，具有高扩展性、低成本、可靠安全等优点。通过控制台、API、SDK 和工具等多样化方式，用户可简 单、快速地接入 COS，进行多格式文件的上传、下载和管理，实现海量数据存储和管理。</p>
<p><img src="/blogs/367fa608/45.jpg" loading="lazy"></p>
<h3 id="Nodejs-操作-COS"><a href="#Nodejs-操作-COS" class="headerlink" title="Nodejs 操作 COS"></a>Nodejs 操作 COS</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/436/8629">https://cloud.tencent.com/document/product/436/8629</a></p>
<ol>
<li>首先安装 sdk 所需依赖：</li>
</ol>
<pre class="language-html" data-language="html"><code class="language-html">cnpm i cos-nodejs-sdk-v5 --save</code></pre>

<ol start="2">
<li>在云端 的 对象存储 -&gt; 存储桶列表 -&gt; 创建存储桶 ，新建一个存储桶，并记住存储桶的 <strong><code>桶名称</code></strong> 及 <strong><code>所属地域</code></strong></li>
</ol>
<p>注意：新建存储桶时需要选择 <strong><code>公有读私有写</code></strong></p>
<p><img src="/blogs/367fa608/46.jpg" loading="lazy"></p>
<ol start="2">
<li>新建 app.js ，写入如下代码：</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token constant">COS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cos-nodejs-sdk-v5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COS</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 此处的 SecretId 及 SecretKey 要从 云平台获取</span>
    SecretId<span class="token operator">:</span> <span class="token string">'AKID0qPr52nJaaJmzxe4D5g2B8pFOGrBDxSg'</span><span class="token punctuation">,</span>
    SecretKey<span class="token operator">:</span> <span class="token string">'xxx'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cos<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    Bucket<span class="token operator">:</span> <span class="token string">'cos110701-1308164762'</span><span class="token punctuation">,</span> <span class="token comment">/* 存储桶名称，必须 */</span>
    Region<span class="token operator">:</span> <span class="token string">'ap-guangzhou'</span><span class="token punctuation">,</span>    <span class="token comment">/* 区域名称 必须 */</span>
    Key<span class="token operator">:</span> <span class="token string">'xxc.jpg'</span><span class="token punctuation">,</span>              <span class="token comment">/* 上传至桶中的文件、目录名称  必须 */</span>
    StorageClass<span class="token operator">:</span> <span class="token string">'STANDARD'</span><span class="token punctuation">,</span>
    Body<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./2.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 上传文件对象，此处为从硬盘读取，下面 express 中是从内存中读取</span>
    <span class="token function-variable function">onProgress</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">progressData</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 成功的回调</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>progressData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>		<span class="token comment">// 失败的回调</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">||</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<ol start="4">
<li>在控制台中输入 nodemon app.js，即可成功将本地图片存储到 云端的 对象存储中。</li>
</ol>
<h3 id="Express-在-Serverless-中实现图片上传"><a href="#Express-在-Serverless-中实现图片上传" class="headerlink" title="Express 在 Serverless 中实现图片上传"></a>Express 在 Serverless 中实现图片上传</h3><ol>
<li>首先通过 Serverless 创建一个 Express 项目</li>
<li>在 <strong><code>views/index.html</code></strong> 中配置如下表单结构</li>
</ol>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/toUpload<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    头像：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>filename<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>提交<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1484605c523a">为什么上传文件要使用 multipart/form-data</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3school.com.cn/tags/att_form_enctype.asp">HTML <form> 标签的 enctype 属性</form></a></p>
<p>通过设置一个表单，让其提交到 post 接口 toUpload ，并确保 <strong><code>enctype</code></strong> 属性为 **<code>multipart/form-data</code>**，因为此处要提交文件。</p>
<ol start="3">
<li>在 <strong><code>app.js</code></strong> 中定义一个 toUpload 接口，并通过使用 <strong><code>multer</code></strong> 模块，来实现对从 <strong>内存</strong> 中文件流的读取</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> <span class="token constant">COS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cos-nodejs-sdk-v5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// 配置上传</span>
<span class="token comment">// 获取内存存储引擎</span>
<span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">memoryStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将文件保存到内存存储引擎中 当使用内存存储引擎，文件信息将包含一个 buffer 字段，里面包含了整个文件数据。</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> storage<span class="token operator">:</span> storage <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义接口</span>
<span class="token comment">// .single接受一个文件名（对应上方的 file 类型 input 标签的 name属性）。这个文件的信息保存在 req.file。</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/toUpload'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> cos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COS</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    SecretId<span class="token operator">:</span> <span class="token string">'AKID0qPr52nJaaJmzxe4D5g2B8pFOGrBDxSg'</span><span class="token punctuation">,</span>
    SecretKey<span class="token operator">:</span> <span class="token string">'xxx'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cos<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    Bucket<span class="token operator">:</span> <span class="token string">'cos110701-1308164762'</span><span class="token punctuation">,</span> <span class="token comment">/* 存储桶名称，必须 */</span>
    Region<span class="token operator">:</span> <span class="token string">'ap-guangzhou'</span><span class="token punctuation">,</span>    <span class="token comment">/* 区域名称 必须 */</span>
    Key<span class="token operator">:</span> <span class="token string">'jmz.jpg'</span><span class="token punctuation">,</span>              <span class="token comment">/* 上传至桶中的文件、目录名称  必须 */</span>
    StorageClass<span class="token operator">:</span> <span class="token string">'STANDARD'</span><span class="token punctuation">,</span>
    Body<span class="token operator">:</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token comment">// 上传文件对象</span>
    <span class="token function-variable function">onProgress</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">progressData</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>progressData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">||</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wjlbk/p/12633320.html">multer中文文档</a></p>
<ol start="4">
<li>代码设置完成后，使用 <strong><code>serverless deploy</code></strong> 即可将 项目部署，然后点击 主页表单的 提交按钮，便可将选中的 文件 提交到 Serverless 对象存储中。</li>
<li>有时候可能 部署的项目 上传的文件无法展示。可以通过配置 <strong><code>serverless.yml</code></strong> 来进行解决。</li>
</ol>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">apigatewayConf</span><span class="token punctuation">:</span>
    <span class="token key atrule">isBase64Encoded</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<h2 id="Serverless、Cos中配置域名访问以及serverless中配置https访问"><a href="#Serverless、Cos中配置域名访问以及serverless中配置https访问" class="headerlink" title="Serverless、Cos中配置域名访问以及serverless中配置https访问"></a>Serverless、Cos中配置域名访问以及serverless中配置https访问</h2><p>要进行本节操作，首先得保证有一个已经备案的域名</p>
<h3 id="Serverless-应用配置域名访问"><a href="#Serverless-应用配置域名访问" class="headerlink" title="Serverless 应用配置域名访问"></a>Serverless 应用配置域名访问</h3><p>进入相关应用的 API网关 页面后，选中自定义域名，点击新建</p>
<p><img src="/blogs/367fa608/115.jpg" loading="lazy"></p>
<p>然后选择 HTTP协议（若要使用 HTTPS 协议，需要先申请 SSL 证书），并添加如下路径映射，然后点击提交，便设置成功。（注意要在 域名解析中添加对应域名解析）</p>
<p><img src="/blogs/367fa608/116.jpg" loading="lazy"></p>
<h3 id="申请-SSL-证书"><a href="#申请-SSL-证书" class="headerlink" title="申请 SSL 证书"></a>申请 SSL 证书</h3><p>主页搜索 SSL证书</p>
<p><img src="/blogs/367fa608/117.jpg" loading="lazy"></p>
<p>选择 自定义配置-&gt; 域名型免费型</p>
<p><img src="/blogs/367fa608/118.jpg" loading="lazy"></p>
<p>快速申请后，选择 DNS验证</p>
<p><img src="/blogs/367fa608/119.jpg" loading="lazy"></p>
<p>在阿里云控制台创建对应 SSL DNS验证 的域名解析。然后等验证成功，即可使用 SSL 证书</p>
<p><img src="/blogs/367fa608/120.jpg" loading="lazy"></p>
<p>申请完SSL证书之后，设置自定义域名时，即可 选择 HTTPS 协议，然后选择证书，之后便可以使用 HTTPS 协议访问。</p>
<p><img src="/blogs/367fa608/122.jpg" loading="lazy"></p>
<h3 id="cos中配置域名访问"><a href="#cos中配置域名访问" class="headerlink" title="cos中配置域名访问"></a>cos中配置域名访问</h3><p><img src="/blogs/367fa608/123.jpg" loading="lazy"></p>
<p>要在COS 中配置域名访问，需要 进入指定COS 的 自定义源站域名-&gt; 添加域名 中添加。添加好后在 对应域名解析中新增域名解析即可访问。</p>
<h1 id="eggjs-基础部分"><a href="#eggjs-基础部分" class="headerlink" title="eggjs 基础部分"></a>eggjs 基础部分</h1><h2 id="eggjs-介绍"><a href="#eggjs-介绍" class="headerlink" title="eggjs 介绍"></a>eggjs 介绍</h2><p>​        Egg.js 是阿里旗下的开源产品—&gt;基于 Node.js 和 Koa研发 , 是一个 Nodejs 的企业级应用 开发框架。可以帮助开发者快速开发高质量的企业级项目。</p>
<p>​        Egg.js 基于 Es6、Es7、Koa 使得 Nodejs 具有更规范的开发模式、更低的学习成本、更优 雅的代码、更少的开发成本、更少的维护成本。它为企业级框架而生。</p>
<p>​        Express 和 Koa 是 Node.js 社区广泛使用的框架，简单且扩展性强，非常适合做个人项 目。但框架本身缺少约定，标准的 MVC 模型会有各种千奇百怪的写法。Egg.js 相比 Express Koa 更规范一些，Egg 按照约定进行开发、内置多进程管理、基于 Koa 开发，性能优异、 具有高度可扩展的插件机制、框架稳定、并提供基于 Egg 定制上层框架的能力。</p>
<p>官 网：<a target="_blank" rel="noopener" href="https://eggjs.org/">https://eggjs.org</a></p>
<p>中文网站：<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/">https://eggjs.org/zh-cn/</a></p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg">https://github.com/eggjs/egg</a></p>
<h2 id="eggjs-快速入门、搭建环境、创建项目"><a href="#eggjs-快速入门、搭建环境、创建项目" class="headerlink" title="eggjs 快速入门、搭建环境、创建项目"></a>eggjs 快速入门、搭建环境、创建项目</h2><blockquote>
<p>一、环境准备 </p>
</blockquote>
<p>操作系统：支持 macOS，Linux，Windows </p>
<p>运行环境：Nodejs建议选择 LTS 版本，最低要求 8.x</p>
<blockquote>
<p>二、安装 egg 脚手架以及使用 egg-init 创建项目</p>
</blockquote>
<p>方法 1：使用脚手架</p>
<pre class="language-none"><code class="language-none">npm i egg-init -g
egg-init egg-example（项目名） --type&#x3D;simple
cd egg-example
npm i

运行项目：
npm run dev</code></pre>

<p>方法2：npm init 快速生成项目</p>
<pre class="language-none"><code class="language-none">mkdir egg-example &amp;&amp; cd egg-example
npm init egg --type&#x3D;simple

npm i

运行项目：
npm run dev</code></pre>

<p><img src="/blogs/367fa608/47.jpg" loading="lazy"></p>
<div class="warning">


<blockquote>
<p>以上两种创建方式效果差不多。但个人偏向于第一种。</p>
</blockquote>
</div>

<h2 id="eggjs-目录结构、路由器、控制器"><a href="#eggjs-目录结构、路由器、控制器" class="headerlink" title="eggjs 目录结构、路由器、控制器"></a>eggjs 目录结构、路由器、控制器</h2><p>一、eggjs 目录结构</p>
<p><img src="/blogs/367fa608/48.jpg" loading="lazy"></p>
<p>二、路由器、控制器</p>
<p>所有的路由都在 <strong><code>app/router.js</code></strong> 中进行配置。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param &#123;Egg.Application&#125; app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>配置路由前，需要创建好对应的 **<code>控制器</code>**，通过在 <strong>app/controller</strong>  文件夹中创建对应的文件，再在文件的 类中通过新建方法的方式，来为路由创建 控制器。</p>
<p><img src="/blogs/367fa608/49.jpg" loading="lazy"></p>
<p>同时，eggjs对目录作出了明确的 <strong><code>规范</code></strong>:</p>
<p><img src="/blogs/367fa608/511.jpg" loading="lazy"></p>
<p>三、VSCode 中插件配置</p>
<p>可以通过在 VSCode中安装 <strong><code>eggjs</code></strong> 插件来提高我们的开发效率</p>
<p><img src="/blogs/367fa608/50.jpg" loading="lazy"></p>
<h2 id="eggjs-路由传参、模板引擎、静态资源"><a href="#eggjs-路由传参、模板引擎、静态资源" class="headerlink" title="eggjs 路由传参、模板引擎、静态资源"></a>eggjs 路由传参、模板引擎、静态资源</h2><p><a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/router.html">eggjs路由的使用</a></p>
<p><a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/controller.html">eggjs控制器的使用</a></p>
<blockquote>
<p>获取 get 传值</p>
</blockquote>
<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// koa 中如何获取 get 传值  ctx.query</span>

        <span class="token comment">// eggjs 中获取 get 传值  this.ctx.query</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"新闻首页"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>之后，我们便可以在 网页中通过在url后使用 ?xxx=xxx的方式为路由传值</p>
<blockquote>
<p>获取动态路由传值</p>
</blockquote>
<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// koa 中获取 动态路由传值  ctx.params</span>

        <span class="token comment">// eggjs 中获取 动态路由传值</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"新闻内容"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/newscontent/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>之后，我们便可以在 网页中通过在url后使用 /xxx 的方式为路由传值</p>
<blockquote>
<p>使用模板引擎渲染页面</p>
</blockquote>
<p>要使用 <strong>模板引擎</strong> 之前，首先得配置好模板引擎，本处以 <strong><code>ejs</code></strong> 为例</p>
<p>首先安装模板引擎</p>
<p><code>npm install egg-view-ejs --save</code></p>
<p>接着在 <strong><code>config/plugin.js</code></strong> 中进行配置：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">exports<span class="token punctuation">.</span>ejs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-view-ejs'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>然后在 <strong><code>config/config.default.js</code></strong> 中配置</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// add your user config here</span>
  <span class="token keyword">const</span> userConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    view<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      mapping<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 表示 .html 文件以 ejs 引擎来编译</span>
        <span class="token string">'.html'</span><span class="token operator">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>userConfig<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>配置完后，使用步骤如下:</p>
<p>配置好对应的路由：</p>
<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">"xxcijmz"</span>
        <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token number">1111</span><span class="token punctuation">,</span>
            <span class="token number">2222</span><span class="token punctuation">,</span>
            <span class="token number">3333</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        <span class="token comment">// 注意：ctx.render 是一个异步方法。</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            msg<span class="token punctuation">,</span>
            list
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span></code></pre>

<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>在 app  中新建 <strong><code>view/list.html</code></strong> （与this.ctx.render对应），此时，这个html 文件会作为 访问 /list 时的请求结果响应，同时，内部可以使用 ejs 语法来显示 <strong><code>ctx.render</code></strong> 传递过去的参数：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>
        我是列表页面
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
    &lt;%= msg %>
        &lt;% for( let i=0; i &lt; list.length; i++ ) &#123; %>
            &lt;%= list[i] %>
                &lt;% &#125; %>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<blockquote>
<p>静态资源使用</p>
</blockquote>
<p>eggjs 默认为我们提供了 可以直接访问 app中public文件夹下静态资源的功能：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/public/css/basic.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>h2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        我是列表页面
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/public/images/2.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p>需要注意的是，访问路径要以 /public 开头。这点与 koa 不同。</p>
<h2 id="eggjs-服务-service-调用、config-配置、及this内容"><a href="#eggjs-服务-service-调用、config-配置、及this内容" class="headerlink" title="eggjs 服务(service) 调用、config 配置、及this内容"></a>eggjs 服务(service) 调用、config 配置、及this内容</h2><div class="success">


<blockquote>
<p>service 服务定义及调用</p>
</blockquote>
</div>



<p>在 eggjs 中，为了符合 MVC 架构，所以规定 有关数据操作(model) 都写在 <strong><code>service</code></strong> 中，不要在 controller 中定义数据。这样既能符合 MVC架构 规范，又使得 service 中定义的数据可以在 <strong><code>多个controller、service</code></strong> 中同时调用。</p>
<p><strong><code>app/service/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NewsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 注意获取新闻数据</span>
        <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'1111'</span><span class="token punctuation">,</span> <span class="token string">'2222'</span><span class="token punctuation">,</span> <span class="token string">'3333'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsService<span class="token punctuation">;</span></code></pre>

<p>在 <strong>service</strong> 文件夹中定义的每一个 <strong>方法</strong> ，都可以通过 this.service.文件名.方法名 的方式在 <strong>controller</strong> 及 <strong><code>service</code></strong> 文件中使用。</p>
<p><strong><code>app/controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">"xxcijmz"</span>
        <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 注意：ctx.render 是一个异步方法。</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            msg<span class="token punctuation">,</span>
            list
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span></code></pre>

<p><strong><code>app/service/test.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> TestService<span class="token punctuation">;</span></code></pre>

<p>需要注意的一点是：service 中的数据由于是定义在异步函数(async)中 ，所以获取时要使用 <strong>await</strong>。</p>
<p><strong><code>服务的命名规则：</code></strong></p>
<p>Service 文件必须放在 app/service 目录，可以支持多级目录，访问的时候可以通过目录名级联访问。</p>
<p>app/service/biz/user.js =&gt; ctx.service.biz.user    (建议)</p>
<p>app/service/sync_user.js =&gt; ctx.service.syncUser</p>
<p>app/service/HackerNews.js =&gt; ctx.service.hackerNews</p>
<div class="success">


<blockquote>
<p>config 配置变量，使其用于所有的 controller 及 service</p>
</blockquote>
</div>

<p>我们可以在 <strong><code>app/config/config.default.js</code></strong> 中通过 config.xxx = xxx 的方式来为 config对象 上绑定属性，使其能够在 controller 和 service 中 通过 this.config.xxx 来获取属性。</p>
<p><strong><code>app/config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  config<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">'xxciiii'</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>config<span class="token punctuation">,</span>
    <span class="token operator">...</span>userConfig<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>app/controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token operator">...</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>test<span class="token punctuation">)</span>
       <span class="token operator">...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span></code></pre>

<div class="success">


<blockquote>
<p>eggjs 会为 Controller 及 Service 类中的 this 挂载一些方法</p>
</blockquote>
</div>

<ul>
<li><code>this.ctx</code>: 当前请求的上下文 <a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/extend.html#context">Context</a> 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。</li>
<li><code>this.app</code>: 当前应用 <a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/extend.html#application">Application</a> 对象的实例，通过它我们可以拿到框架提供的全局对象和方法。</li>
<li><code>this.service</code>：应用定义的 <a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/service.html">Service</a>，通过它我们可以访问到其他业务层，等价于 <code>this.ctx.service</code> 。</li>
<li><code>this.config</code>：应用运行时的<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/config.html">配置项</a>。</li>
<li><code>this.logger</code>：logger 对象，上面有四个方法（<code>debug</code>，<code>info</code>，<code>warn</code>，<code>error</code>），分别代表打印四个不同级别的日志，使用方法和效果与 <a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/core/logger.html#context-logger">context logger</a> 中介绍的一样，但是通过这个 logger 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</li>
</ul>
<h2 id="eggjs-实现简单爬虫"><a href="#eggjs-实现简单爬虫" class="headerlink" title="eggjs 实现简单爬虫"></a>eggjs 实现简单爬虫</h2><p>首先在 <strong><code>router.js</code></strong> 及 <strong><code>controller/news.js</code></strong> 中注册好对应的路由及 处理函数：</p>
<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>getNewsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/content'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>getContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> newsList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            list<span class="token operator">:</span> newsList
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">async</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> aid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>aid<span class="token punctuation">;</span>
        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span>aid<span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            content
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span></code></pre>

<p>定义完成后，去 <strong><code>service/news.js</code></strong> 中请求数据（此处需要先在 config/config.default.js中配置一下共用 url 地址）:</p>
<p><strong><code>config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  config<span class="token punctuation">.</span>api <span class="token operator">=</span> <span class="token string">'http://www.phonegap100.com/appapi.php?'</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>service/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NewsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">getNewsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>api <span class="token operator">+</span> <span class="token string">'a=getPortalList&amp;catid=20&amp;page=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 16进制数据 转换为对象</span>
        <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">async</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter">aid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>api <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">a=getPortalArticle&amp;aid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>aid <span class="token operator">*</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> content<span class="token punctuation">.</span>result
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsService<span class="token punctuation">;</span>
</code></pre>

<p>定义完 service 后，我们便可以在 <strong><code>view</code></strong> 中的模板页面中使用 在 controller 中 通过 service 获取的数据：</p>
<p><strong><code>view/content.html</code></strong></p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
        &lt;% for( let i=0; i &lt; list.length; i++ ) &#123; %>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/content?aid=&lt;%= list[i].aid %> <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    &lt;%=list[i].title %>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
            &lt;% &#125; %>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p><strong><code>view/index.html</code></strong></p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    &lt;%- content[0].content %>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<h2 id="eggjs-框架扩展配置"><a href="#eggjs-框架扩展配置" class="headerlink" title="eggjs 框架扩展配置"></a>eggjs 框架扩展配置</h2><h3 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h3><p><code>app</code> 对象指的是 Koa 的全局应用对象，全局只有一个，在应用启动时被创建。</p>
<p><strong><code>访问方式</code></strong></p>
<ul>
<li><code>ctx.app</code></li>
<li>Controller，Middleware，Helper，Service 中都可以通过 <code>this.app</code> 访问到 Application 对象，例如 <code>this.app.config</code> 访问配置对象。</li>
</ul>
<p><strong><code>扩展方式</code></strong></p>
<p>框架会把 <code>app/extend/application.js</code> 中定义的对象与 Koa Application 的 prototype 对象进行合并，在应用启动时会基于扩展后的 prototype 生成 <code>app</code> 对象。</p>
<p><strong><code>方法扩展</code></strong></p>
<p>例如，我们要增加一个 <code>app.foo()</code> 方法：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/application.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this 就是 app 对象，在其中可以调用 app 上的其他方法，或访问属性</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>属性扩展</code></strong></p>
<p>一般来说属性的计算只需要进行一次，那么一定要实现缓存，否则在多次访问属性时会计算多次，这样会降低应用性能。</p>
<p>推荐的方式是使用 Symbol + Getter 的模式。</p>
<p>例如，增加一个 <code>app.bar</code> 属性 Getter：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/application.js</span>
<span class="token keyword">const</span> <span class="token constant">BAR</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'Application#bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this 就是 app 对象，在其中可以调用 app 上的其他方法，或访问属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 实际情况肯定更复杂</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>xx <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>yy<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>外部使用</code></strong></p>
<p><strong><code>controller/home.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">...</span> 
<span class="token keyword">async</span> <span class="token function">extendTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">...</span></code></pre>



<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Context 指的是 Koa 的请求上下文，这是 <strong>请求级别</strong> 的对象，每次请求生成一个 Context 实例，通常我们也简写成 <code>ctx</code>。在所有的文档中，Context 和 <code>ctx</code> 都是指 Koa 的上下文对象。</p>
<p><strong><code>访问方式</code></strong></p>
<ul>
<li>middleware 中 <code>this</code> 就是 ctx，例如 <code>this.cookies.get(&#39;foo&#39;)</code>。</li>
<li>controller 有两种写法，类的写法通过 <code>this.ctx</code>，方法的写法直接通过 <code>ctx</code> 入参。</li>
<li>helper，service 中的 this 指向 helper，service 对象本身，使用 <code>this.ctx</code> 访问 context 对象，例如 <code>this.ctx.cookies.get(&#39;foo&#39;)</code>。</li>
</ul>
<p><strong><code>扩展方式</code></strong></p>
<p>框架会把 <code>app/extend/context.js</code> 中定义的对象与 Koa Context 的 prototype 对象进行合并，在处理请求时会基于扩展后的 prototype 生成 ctx 对象。</p>
<p><strong><code>方法扩展</code></strong></p>
<p>例如，我们要增加一个 <code>ctx.foo()</code> 方法：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/context.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this 就是 ctx 对象，在其中可以调用 ctx 上的其他方法，或访问属性</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>属性扩展</code></strong></p>
<p>一般来说属性的计算在同一次请求中只需要进行一次，那么一定要实现缓存，否则在同一次请求中多次访问属性时会计算多次，这样会降低应用性能。</p>
<p>推荐的方式是使用 Symbol + Getter 的模式。</p>
<p>例如，增加一个 <code>ctx.bar</code> 属性 Getter：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/context.js</span>
<span class="token keyword">const</span> <span class="token constant">BAR</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'Context#bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this 就是 ctx 对象，在其中可以调用 ctx 上的其他方法，或访问属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 例如，从 header 中获取，实际情况肯定更复杂</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'x-bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>



<h3 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h3><p>Helper 函数用来提供一些实用的 工具函数。</p>
<p>它的作用在于我们可以将一些常用的动作抽离在 helper.js 里面成为一个独立的函数，这样可以用 JavaScript 来写复杂的逻辑，避免逻辑分散各处。另外还有一个好处是 Helper 这样一个简单的函数，可以让我们更容易编写测试用例。</p>
<p>框架内置了一些常用的 Helper 函数。我们也可以编写自定义的 Helper 函数。</p>
<p><strong><code>访问方式</code></strong></p>
<p>通过 <code>ctx.helper</code> 访问到 helper 对象。</p>
<p><strong><code>扩展方式</code></strong></p>
<p>框架会把 <code>app/extend/helper.js</code> 中定义的对象与内置 <code>helper</code> 的 prototype 对象进行合并，在处理请求时会基于扩展后的 prototype 生成 <code>helper</code> 对象。</p>
<p>例如，增加一个 <code>helper.foo()</code> 方法：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/helper.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this 是 helper 对象，在其中可以调用其他 helper 方法</span>
    <span class="token comment">// this.ctx => context 对象</span>
    <span class="token comment">// this.app => application 对象</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>helper.js实现时间戳转换</code></strong></p>
<p><strong><code>extend/helper.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> dayjs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dayjs'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token function">dateFormat</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> dayjs<span class="token punctuation">.</span><span class="token function">unix</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY/MM/DD'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>view/index.html</code></strong></p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
        &lt;% for( let i=0; i &lt; list.length; i++ ) &#123; %>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/content?aid=&lt;%= list[i].aid %> <span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                    &lt;%=list[i].title %>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
                ---
                &lt;%= helper.dateFormat(list[i].dateline) %>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
            &lt;% &#125; %>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><p>Request 对象和 Koa 的 Request 对象相同，是 <strong>请求级别</strong> 的对象，它提供了大量请求相关的属性和方法供使用。</p>
<p><strong><code>访问方式</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">ctx<span class="token punctuation">.</span>request</code></pre>

<p><code>ctx</code> 上的很多属性和方法都被代理到 <code>request</code> 对象上，对于这些属性和方法使用 <code>ctx</code> 和使用 <code>request</code> 去访问它们是等价的，例如 <code>ctx.url === ctx.request.url</code>。</p>
<p>Koa 内置的代理 <code>request</code> 的属性和方法列表：<a target="_blank" rel="noopener" href="http://koajs.com/#request-aliases">Koa - Request aliases</a></p>
<p><strong><code>扩展方式</code></strong></p>
<p>框架会把 <code>app/extend/request.js</code> 中定义的对象与内置 <code>request</code> 的 prototype 对象进行合并，在处理请求时会基于扩展后的 prototype 生成 <code>request</code> 对象。</p>
<p>例如，增加一个 <code>request.foo</code> 属性 Getter：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app/extend/request.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">get</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'x-request-foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p>Response 对象和 Koa 的 Response 对象相同，是 <strong>请求级别</strong> 的对象，它提供了大量响应相关的属性和方法供使用。</p>
<p><strong><code>访问方式</code></strong></p>
<pre class="language-none"><code class="language-none">ctx.response</code></pre>

<p>ctx 上的很多属性和方法都被代理到 <code>response</code> 对象上，对于这些属性和方法使用 <code>ctx</code> 和使用 <code>response</code> 去访问它们是等价的，例如 <code>ctx.status = 404</code> 和 <code>ctx.response.status = 404</code> 是等价的。</p>
<p>Koa 内置的代理 <code>response</code> 的属性和方法列表：<a target="_blank" rel="noopener" href="http://koajs.com/#response-aliases">Koa Response aliases</a></p>
<p><strong><code>扩展方式</code></strong></p>
<p>框架会把 <code>app/extend/response.js</code> 中定义的对象与内置 <code>response</code> 的 prototype 对象进行合并，在处理请求时会基于扩展后的 prototype 生成 <code>response</code> 对象。</p>
<p>例如，增加一个 <code>response.foo</code> 属性 setter：</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; app&#x2F;extend&#x2F;response.js
module.exports &#x3D; &#123;
  set foo(value) &#123;
    this.set(&#39;x-response-foo&#39;, value);
  &#125;,
&#125;;</code></pre>

<p>就可以这样使用啦：<code>this.response.foo = &#39;bar&#39;;</code></p>
<h2 id="eggjs-中间件配置"><a href="#eggjs-中间件配置" class="headerlink" title="eggjs 中间件配置"></a>eggjs 中间件配置</h2><p>Egg 的中间件形式和 Koa 的中间件形式是一样的，都是基于<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/intro/egg-and-koa.html#midlleware">洋葱圈模型</a>。每次我们编写一个中间件，就相当于在洋葱外面包了一层。</p>
<h3 id="定义中间件"><a href="#定义中间件" class="headerlink" title="定义中间件"></a>定义中间件</h3><p>Egg 中规定 中间件的定义必须在 <strong><code>app/middleware</code></strong> 中进行</p>
<p><strong><code>app/middleware/printdate.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// options: 中间件的配置项，框架会将 app.config[$&#123;middlewareName&#125;] 传递进来。</span>
<span class="token comment">// app: 当前应用 Application 的实例。</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>定义完中间件后，需要在 <strong><code>config/config.default.js</code></strong> 中配置，同时可以在其中为配置的中间件 <strong>传递参数</strong> </p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 配置中间件</span>
  config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'printdate'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 为配置的中间件传递参数。</span>
  config<span class="token punctuation">.</span>printdate <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'aaa'</span><span class="token operator">:</span> <span class="token string">'123456'</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>config<span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h3 id="使用中间件进行域名禁用"><a href="#使用中间件进行域名禁用" class="headerlink" title="使用中间件进行域名禁用"></a>使用中间件进行域名禁用</h3><ol>
<li>定义中间件</li>
</ol>
<p><strong><code>app/middleware/forbidip.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 通过数据库获取数据的方式（此处以固定数据模拟）</span>

<span class="token comment">// module.exports = function (options, app) &#123;</span>
<span class="token comment">//     return async function forbidId(ctx, next) &#123;</span>
<span class="token comment">//         const ip = '127.0.0.1'</span>
<span class="token comment">//         if (ctx.request.ip === ip) &#123;</span>
<span class="token comment">//             ctx.status = 403</span>
<span class="token comment">//             ctx.body = "您的 ip 已经被屏蔽"</span>
<span class="token comment">//         &#125; else &#123;</span>
<span class="token comment">//             await next()</span>
<span class="token comment">//         &#125;</span>
<span class="token comment">//     &#125;</span>
<span class="token comment">// &#125;</span>

<span class="token comment">// 通过 options 传入参数的形式</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">forbidIp</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> ids <span class="token operator">=</span> options<span class="token punctuation">.</span>forbidip
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ids<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">403</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'你的 ip 已被禁止'</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="2">
<li>配置中间件</li>
</ol>
<p><strong><code>config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'forbidip'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">// 此处的名称要与 middleware 中 中间件 的文件名对应</span>
config<span class="token punctuation">.</span>forbidip <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  forbidip<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token string">'192.168.1.107'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="eggjs-Post-提交数据、Egg-js-安全机制-CSRF-的防范、以及配置模板全局变量"><a href="#eggjs-Post-提交数据、Egg-js-安全机制-CSRF-的防范、以及配置模板全局变量" class="headerlink" title="eggjs Post 提交数据、Egg.js 安全机制 CSRF 的防范、以及配置模板全局变量"></a>eggjs Post 提交数据、Egg.js 安全机制 CSRF 的防范、以及配置模板全局变量</h2><blockquote>
<p>模拟eggjs 中通过 post 提交数据：</p>
</blockquote>
<p><strong><code>view/index.html</code></strong></p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/add<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>提交<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p><strong><code>app/router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
    <span class="token operator">...</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>clgadd<span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">async</span> <span class="token function">clgadd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>此种写法，当我们提交表单后，会显示如下错误页面：</p>
<p><img src="/blogs/367fa608/51.jpg" loading="lazy"></p>
<p>原因是由于框架本身提供了 **<code>CSRF防御方案</code>**。</p>
<p>要解决这个问题。我们需要通过 this.ctx.csrf 为 模板传递一个 <strong><code>csrf</code></strong> 字符串，每当我们提交表单时，都要 <strong><code>带上这个字符串</code></strong></p>
<p><strong><code>view/index.html</code></strong></p>
<p>方式一：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/add?_csrf=&lt;%= csrf %> <span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>提交<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>

<p>方式二：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/add<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_csrf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%=csrf%><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>提交<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>



<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// this.ctx.body = "你好"</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        csrf<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>csrf
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>



<p>虽然以上方式可以解决问题，但若我们要在 多处路由 中提交表格的话，那我们每次都要给模板传递数据，比较麻烦。</p>
<p>所以下面我们使用 <strong><code>配置模板全局变量</code></strong> （通过给 ctx.state 中添加的属性变为全局变量的特性）的方式来实现 相同效果：</p>
<p>首先定义一个 中间件，在其中定义全局变量</p>
<p><strong><code>middleware/auth.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>csrf <span class="token operator">=</span> ctx<span class="token punctuation">.</span>csrf
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>然后在 <strong><code>config/config.default.js</code></strong> 中配置中间件：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置中间件</span>
config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'auth'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>

<p>如此一来，即便我们在 <strong>controller</strong> 中不传递 csrf，也可以在模板中直接使用 <strong><code>csrf变量</code></strong></p>
<h2 id="egg-js-中-Cookie-的使用"><a href="#egg-js-中-Cookie-的使用" class="headerlink" title="egg.js 中 Cookie 的使用"></a>egg.js 中 Cookie 的使用</h2><h3 id="Cookie-简介"><a href="#Cookie-简介" class="headerlink" title="Cookie 简介"></a>Cookie 简介</h3><ul>
<li><p>cookie 是存储于访问者的计算机中的变量。可以让我们用同一个浏览器访问同一个域 名的时候共享数据。（cookie 不可跨域名）</p>
</li>
<li><p>HTTP 是无状态协议。简单地说，当你浏览了一个页面，然后转到同一个网站的另一个页 面，服务器无法认识到这是同一个浏览器在访问同一个网站。每一次的访问，都是没有任何 关系的。</p>
</li>
<li><p>cookie 的功能</p>
<ul>
<li>实现同一浏览器在统一域名下 ，不同页面间的数据共享</li>
<li>实现数据的持久化（退出浏览器后数据会保存，默认情况下cookies 当浏览器关闭后销毁）</li>
</ul>
</li>
</ul>
<h3 id="eggjs-中-cookie-的设置和获取"><a href="#eggjs-中-cookie-的设置和获取" class="headerlink" title="eggjs 中 cookie 的设置和获取"></a>eggjs 中 cookie 的设置和获取</h3><p>主要通过 <strong><code>ctx.cookies.get 与 ctx.cookies.set</code></strong> 来设置和获取</p>
<p><strong><code>app/controller/cookie.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">CookieController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 设置 cookie</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'xxc'</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">async</span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取 cookie</span>
        <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'detail'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            username
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="eggjs-中-cookie-的参数-options"><a href="#eggjs-中-cookie-的参数-options" class="headerlink" title="eggjs 中 cookie 的参数 options"></a>eggjs 中 cookie 的参数 options</h3><p><img src="/blogs/367fa608/52.jpg" loading="lazy"></p>
<p><strong><code>推荐配置：</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'xxc'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        maxAge<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>    <span class="token comment">// cookie 存储一天，设置 后，重新打开浏览器，cookie 还在</span>
        httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        signed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment">// 对 cookie 进行签名，防止用户修改 cookie。</span>
        encrypt<span class="token operator">:</span> <span class="token boolean">true</span>       <span class="token comment">// 对 cookie 进行加密，如果对 cookie 加密，则获取的时候需要对 cookie 进行解密操作</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        encrypt<span class="token operator">:</span> <span class="token boolean">true</span>       <span class="token comment">// cookie 解密</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="egg-js-中设置中文-Cookie"><a href="#egg-js-中设置中文-Cookie" class="headerlink" title="egg.js 中设置中文 Cookie"></a>egg.js 中设置中文 Cookie</h3><p>egg.js 默认不支持 中文Cookie，要想实现设置中文 Cookie，需要使用以下两种方式：</p>
<p>方式一：使用 <strong><code>Buffer</code></strong> 将中文转为 base64 字符串后再转回</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cookieValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'语轻星子'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> cookieValue<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        maxAge<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>    
        httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        signed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'detail'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        username
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>方式二：添加 <strong><code>encrypt</code></strong> 属性</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'薛昕铖'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        maxAge<span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>
        httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        signed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        encrypt<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        encrypt<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'detail'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        username
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="清除-Cookie"><a href="#清除-Cookie" class="headerlink" title="清除 Cookie"></a>清除 Cookie</h3><p><code>this.ctx.cookies.set(&#39;name&#39;,null);</code></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">loginOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="egg-js-中-Session-的使用"><a href="#egg-js-中-Session-的使用" class="headerlink" title="egg.js 中 Session 的使用"></a>egg.js 中 Session 的使用</h2><h3 id="Session-简介"><a href="#Session-简介" class="headerlink" title="Session 简介"></a>Session 简介</h3><p>session 是另一种记录客户状态的机制，不同的是 Cookie 保存在客户端浏览器中，而 session 保存在服务器上。</p>
<p>当浏览器访问服务器并发送第一次请求时，服务器端会创建一个 session 对象，生成一个类似于 key，value 的键值对， 然后将 key(cookie)返回到浏览器(客户)端，浏览器下次再 访问时，携带 key(cookie)，找到对应的 session(value)。</p>
<h3 id="eggjs-中-session-的设置和获取"><a href="#eggjs-中-session-的设置和获取" class="headerlink" title="eggjs 中 session 的设置和获取"></a>eggjs 中 session 的设置和获取</h3><p><strong><code>设置 session</code></strong></p>
<p><strong><code>controller/home.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//设置session</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'张三'</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userinfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      name<span class="token operator">:</span> <span class="token string">'李四'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">20</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//设置session的过期时间   修改session的默认参数  不建议用这样的方式</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>获取 session</code></strong></p>
<p><strong><code>controller/news.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token keyword">var</span> username<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
    <span class="token keyword">var</span> userinfo<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userinfo<span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'news'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
      username<span class="token operator">:</span>username
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="egg-js-中-配置session"><a href="#egg-js-中-配置session" class="headerlink" title="egg.js 中 配置session"></a>egg.js 中 配置session</h3><p><strong><code>session的默认配置：</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">exports<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	key<span class="token operator">:</span> <span class="token string">'EGG_SESS'</span><span class="token punctuation">,</span>
	maxAge<span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 1 day</span>
	httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	encrypt<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>修改session 配置：</p>
<p><strong><code>controller/home.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//设置session的过期时间   修改session的默认参数  不建议用这样的方式</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>maxAge<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">;</span> </code></pre>

<p>在 <strong><code>config.default.js</code></strong> 中配置session：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//配置session      session的配置和cookie基本是一样的，可以使用cookie里面的配置</span>
config<span class="token punctuation">.</span>session<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    key<span class="token operator">:</span><span class="token string">'SESSION_ID'</span><span class="token punctuation">,</span>   <span class="token comment">//设置session cookie里面的key</span>
    maxAge<span class="token operator">:</span><span class="token number">30</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span>
    httpOnly<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>     
    encrypt<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    renew<span class="token operator">:</span><span class="token boolean">true</span>   <span class="token comment">//renew设置为true  那么每次刷新页面的时候 session都会被延期</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="router-js-中使用中间件、框架默认中间件、Egg-中使用-Koa-中间件"><a href="#router-js-中使用中间件、框架默认中间件、Egg-中使用-Koa-中间件" class="headerlink" title="router.js 中使用中间件、框架默认中间件、Egg 中使用 Koa 中间件"></a>router.js 中使用中间件、框架默认中间件、Egg 中使用 Koa 中间件</h2><h3 id="全局中间件配置"><a href="#全局中间件配置" class="headerlink" title="全局中间件配置"></a>全局中间件配置</h3><ol>
<li>定义中间件</li>
</ol>
<p><strong><code>middleware/auth.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token comment">// 实现中间件的功能</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="2">
<li>在 <strong><code>config/config.default.js</code></strong> 中配置</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置中间件</span>
config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'auth'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 给中间件传参</span>
config<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  title<span class="token operator">:</span> <span class="token string">'this is auth'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>之后启动项目，每访问一次路由，都会触发该中间件。</p>
<h3 id="router-js-中使用中间件"><a href="#router-js-中使用中间件" class="headerlink" title="router.js 中使用中间件"></a>router.js 中使用中间件</h3><p>要想实现在 **<code>某些路由中单独使用中间件</code>**，便需要采用以下写法</p>
<ol>
<li>定义中间件，这一步不变</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
        <span class="token comment">// 实现中间件的功能</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="2">
<li>在 <strong><code>router.js</code></strong> 中获取中间件，并使用</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

  <span class="token keyword">const</span> auth <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> title<span class="token operator">:</span> <span class="token string">"this is router.js middleware"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ol start="3">
<li>此后，只有当访问 ‘/’ 时，才会调用中间件。</li>
</ol>
<h3 id="配置框架默认中间件"><a href="#配置框架默认中间件" class="headerlink" title="配置框架默认中间件"></a>配置框架默认中间件</h3><p>eggjs 中有一些框架已经集成了的中间件，我们可以直接在 <strong><code>config/config.default.js</code></strong> 中去进行配置：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 框架中间件 的 默认配置</span>
config<span class="token punctuation">.</span>bodyParser<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    jsonLimit<span class="token operator">:</span> <span class="token string">'10mb'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></code></pre>

<h3 id="Egg-中使用-Koa-中间件（标准）"><a href="#Egg-中使用-Koa-中间件（标准）" class="headerlink" title="Egg 中使用 Koa 中间件（标准）"></a>Egg 中使用 Koa 中间件（标准）</h3><p>koa 中的 中间件，都可以在 egg.js 中使用。</p>
<ol>
<li>安装 </li>
</ol>
<pre class="language-html" data-language="html"><code class="language-html">cnpm install koa-jsonp --save</code></pre>

<ol start="2">
<li>新建中间件文件</li>
</ol>
<p><strong><code>middleware/jsonp.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-jsonp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<ol start="3">
<li>在 <strong><code>config/config.default.js</code></strong> 中配置：</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置中间件</span>
config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'jsonp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>

<ol start="4">
<li>此后便可以正常使用。</li>
</ol>
<p>接下来再试一试 <strong><code>koa-compress</code></strong> 的使用：</p>
<ol>
<li>安装</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">cnpm install koa<span class="token operator">-</span>compress <span class="token operator">--</span>save</code></pre>

<ol start="2">
<li>新建中间件文件</li>
</ol>
<p><strong><code>middleware/compress.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// egg.js 中使用 koa-compress 开启压缩</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-compress'</span><span class="token punctuation">)</span></code></pre>

<ol start="3">
<li>在 <strong><code>config/config.default.js</code></strong> 中配置：</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置中间件</span>
config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'compress'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

config<span class="token punctuation">.</span>compress <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  threshold<span class="token operator">:</span> <span class="token number">1024</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="Egg-中使用-Koa-中间件（非标准）"><a href="#Egg-中使用-Koa-中间件（非标准）" class="headerlink" title="Egg 中使用 Koa 中间件（非标准）"></a>Egg 中使用 Koa 中间件（非标准）</h3><p>定义时，将中间件以 <strong><code>高阶函数</code></strong> 的形式返回。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> webpackMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'some-koa-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">webpackMiddleware</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>compiler<span class="token punctuation">,</span> options<span class="token punctuation">.</span>others<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="中间件的通用配置"><a href="#中间件的通用配置" class="headerlink" title="中间件的通用配置"></a>中间件的通用配置</h2><p>无论是应用层加载的中间件还是框架自带中间件，都支持几个通用的配置项：</p>
<ul>
<li>enable：控制中间件是否开启。</li>
<li>match：设置只有符合某些规则的请求才会经过这个中间件。</li>
<li>ignore：设置符合某些规则的请求不经过这个中间件。</li>
</ul>
<h3 id="enable"><a href="#enable" class="headerlink" title="enable"></a>enable</h3><p>如果我们的应用并不需要默认的 bodyParser 中间件来进行请求体的解析，此时我们可以通过配置 enable 为 false 来关闭它</p>
<p><strong><code>config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">config<span class="token punctuation">.</span>bodyParser<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    enable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></code></pre>

<h3 id="match-和-ignore"><a href="#match-和-ignore" class="headerlink" title="match 和 ignore"></a>match 和 ignore</h3><p>match 和 ignore 支持的参数都一样，只是作用完全相反，match 和 ignore **<code>不允许同时配置</code>**。</p>
<p>如果我们想让 gzip 只针对 <code>/static</code> 前缀开头的 url 请求开启，我们可以配置 match 选项</p>
<p><strong><code>config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">config<span class="token punctuation">.</span>gzip<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    match<span class="token operator">:</span> <span class="token string">'/static'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></code></pre>

<p>match 和 ignore 支持多种类型的配置方式</p>
<ol>
<li>字符串：当参数为字符串类型时，配置的是一个 url 的路径前缀，所有以配置的字符串作为前缀的 url 都会匹配上。 当然，你也可以直接使用字符串数组。</li>
<li>正则：当参数为正则时，直接匹配满足正则验证的 url 的路径。</li>
<li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（true/false）来判断是否匹配。</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  gzip<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 只有 ios 设备才开启</span>
      <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">iphone|ipad|ipod</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<blockquote>
<p>通过 match 和 ignore ，可以使得 中间件区分路由使用变得更方便，不需要再在 router.js 中加载中间件并给每个路由配置。</p>
</blockquote>
<h2 id="使用中间件实现权限校验"><a href="#使用中间件实现权限校验" class="headerlink" title="使用中间件实现权限校验"></a>使用中间件实现权限校验</h2><p>本节通过 为特定路由添加中间件校验，来实现 模拟后台权限校验的功能。</p>
<ol>
<li>首先，新建 <strong>控制器</strong>，注意本处对控制器进行了 <strong>分组操作</strong>，以便后期维护</li>
</ol>
<p><img src="/blogs/367fa608/53.jpg" loading="lazy"></p>
<ol start="2">
<li>在 <strong><code>router.js</code></strong> 中，建立 **<code>路由</code>**，并为每个路由匹配对应的 <strong><code>控制器</code></strong></li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

  <span class="token comment">// 后台 </span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/user'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/add'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/edit'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/add'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/edit'</span><span class="token punctuation">,</span>  controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// api 接口</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/product'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>product<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 前台首页</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ol start="3">
<li>定义 中间件，此处先不要在 <strong><code>config.default.js</code></strong> 中配置中间件</li>
</ol>
<p><strong><code>middleware/admin_auth.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> nect</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果 session 存在表示已经登录 继续访问，如果 session 不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="4">
<li>在 <strong><code>router.js</code></strong> 中，为所有的 <strong>后台路由</strong> 配置中间件：</li>
</ol>
<p>注意：此处中间件的名称要以驼峰式命名（不可以以 <strong><code>xxx_xxx</code></strong> 的形式命名）</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>


  <span class="token keyword">const</span> auth <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">adminAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 后台 </span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/user'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/add'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/edit'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/add'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/edit'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// api 接口</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/product'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>product<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 前台首页</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
</code></pre>

<ol start="5">
<li>此后，当我们访问 /admin 开头的路由时，就会触发权限验证。</li>
</ol>
<ol start="6">
<li>除了上面这种方法，我们还可以在 <strong><code>config.default.js</code></strong> 中进行配置：</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 注意此处的 名称 也要以 驼峰形式 命名。</span>
config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'adminAuth'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 对后台管理的页面进行通用配置</span>
config<span class="token punctuation">.</span>adminAuth <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  match<span class="token operator">:</span> <span class="token string">'/admin'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这样配置后，就不需要在 <strong><code>router.js</code></strong> 中再以上面那种较为复杂的形式配置了。</p>
<h2 id="路由的几种写法、路由重定向、路由分组（路由映射）"><a href="#路由的几种写法、路由重定向、路由分组（路由映射）" class="headerlink" title="路由的几种写法、路由重定向、路由分组（路由映射）"></a>路由的几种写法、路由重定向、路由分组（路由映射）</h2><h3 id="路由的几种写法"><a href="#路由的几种写法" class="headerlink" title="路由的几种写法"></a>路由的几种写法</h3><p><a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/router.html">官方文档</a></p>
<ol>
<li>普通写法 router.verb(路由地址，控制器)</li>
<li>包含中间件写法：router.verb(路由地址，中间件….，控制器)</li>
<li>为路由起名：router.verb(路由名称，路由地址，控制器)</li>
<li>起名同时使用中间件：router.verb(路由名称，路由地址，中间件…，控制器)</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> adminAuth <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">adminAuth</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> title<span class="token operator">:</span> <span class="token string">'this is router.js  middleware'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 1</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span> <span class="token string">'/admin/article'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article'</span><span class="token punctuation">,</span> adminAuth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'admin_article'</span><span class="token punctuation">,</span> <span class="token string">'/admin/article'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 4</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'admin_article'</span><span class="token punctuation">,</span> <span class="token string">'/admin/article'</span><span class="token punctuation">,</span> adminAuth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h3 id="路由的重定向"><a href="#路由的重定向" class="headerlink" title="路由的重定向"></a>路由的重定向</h3><h4 id="外部重定向"><a href="#外部重定向" class="headerlink" title="外部重定向"></a>外部重定向</h4><p><strong><code>controller/admin/product.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ProductController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// this.ctx.body = "后台商品管理列表"</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">301</span><span class="token punctuation">;</span>      <span class="token comment">// 把重定向改为301(永久重定向)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/product/add'</span><span class="token punctuation">)</span>     <span class="token comment">// 默认是一个临时重定向 302</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>



<h4 id="内部重定向"><a href="#内部重定向" class="headerlink" title="内部重定向"></a>内部重定向</h4><p>有利于 seo 优化</p>
<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// router.get('/admin/product', controller.admin.product.index);	// 这行代码不用写</span>
router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/product'</span><span class="token punctuation">,</span> <span class="token string">'/admin/product/add'</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h3 id="路由分组"><a href="#路由分组" class="headerlink" title="路由分组"></a>路由分组</h3><p>当路由很多的时候，将 路由 抽离</p>
<ol>
<li>在 app 中新建 <strong>routers</strong> 文件夹，并在其中新建 index.js 、admin.js、api.js 文件</li>
<li>在不同的文件写入对应的路由，最终在 <strong><code>router.js</code></strong> 中导入</li>
</ol>
<p><strong><code>routers/index.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param &#123;Egg.Application&#125; app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
    <span class="token comment">// 前台首页</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>routers/admin.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param &#123;Egg.Application&#125; app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

    <span class="token keyword">let</span> adminAuth <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">adminAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 后台 </span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/user'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'admin_article'</span><span class="token punctuation">,</span> <span class="token string">'/admin/article'</span><span class="token punctuation">,</span> adminAuth<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/article/edit'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>article<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// router.get('/admin/product', controller.admin.product.index);</span>

    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/product/edit'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>product<span class="token punctuation">.</span>edit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>routers/api.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param &#123;Egg.Application&#125; app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

    <span class="token comment">// api 接口</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>user<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/product'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>product<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>router.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param &#123;Egg.Application&#125; app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routers/admin'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routers/api'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routers/index'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h2 id="控制器基类BaseController、控制器兼容写法"><a href="#控制器基类BaseController、控制器兼容写法" class="headerlink" title="控制器基类BaseController、控制器兼容写法"></a>控制器基类BaseController、控制器兼容写法</h2><p>我们要实现一个功能：编写登录注册页面，当注册成功时，先跳转到 <strong>注册成功页面</strong>，并在 3秒后跳转到登录页，当 登录成功后，先跳转到 <strong>登录成功页面</strong>，3秒后跳转到 登录前页面。 考虑到可能会有很多 路由要用到对应的 跳转到到成功页面的功能，此时我们便可以在 <strong><code>控制器基类BaseController</code></strong> 中 定义对应的方法。然后让控制器继承这个基类，便可调用里面的方法。</p>
<p><strong><code>core/base.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token comment">// 此处继承 Controller 类，之后继承本类的类，也可以使用 Controller 中的方法</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      name<span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">20</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">async</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">redirectUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'public/success'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      redirectUrl<span class="token operator">:</span> redirectUrl <span class="token operator">||</span> <span class="token string">'/'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>
  <span class="token keyword">async</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">redirectUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'public/error'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      redirectUrl<span class="token operator">:</span> redirectUrl <span class="token operator">||</span> <span class="token string">'/'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span></code></pre>

<p><strong><code>controller/user.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> BaseController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../core/base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 此处继承 BaseController 类，而不是 Controller。</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 登录表单 提交路由对应控制器</span>
  <span class="token keyword">async</span> <span class="token function">doLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//注意 await</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    
  <span class="token comment">// 注册表单 提交路由对应控制器</span>
  <span class="token keyword">async</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>



<p><strong>控制器兼容写法（不推荐使用，只是为了兼容）</strong>：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 传入 ctx 参数（类似于 koa）</span>
	<span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 直接通过 ctx. 调用方法，而不是 this.ctx.</span>
		<span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span></code></pre>

<h2 id="egg-js-定时任务"><a href="#egg-js-定时任务" class="headerlink" title="egg.js 定时任务"></a>egg.js 定时任务</h2><p><a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/schedule.html">官方文档</a></p>
<p>所有的定时任务都统一存放在 <code>app/schedule</code> 目录下，每一个文件都是一个独立的定时任务，可以配置定时任务的属性和要执行的方法。</p>
<p>一个简单的例子，我们定义一个更新远程数据到内存缓存的定时任务，就可以在 <code>app/schedule</code> 目录下创建一个 <code>update_cache.js</code> 文件</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Subscription <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Subscription<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UpdateCache</span> <span class="token keyword">extends</span> <span class="token class-name">Subscription</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 通过 schedule 属性来设置定时任务的执行间隔等配置</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      interval<span class="token operator">:</span> <span class="token string">'1m'</span><span class="token punctuation">,</span> <span class="token comment">// 1 分钟间隔</span>
      type<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token comment">// 指定所有的 worker 都需要执行</span>
      <span class="token comment">// disable:true     // 设置为 true 时，该定时任务不会被启动。</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// subscribe 是真正定时任务执行时被运行的函数</span>
  <span class="token keyword">async</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      
    <span class="token comment">// 在定时任务中调用服务里的方法</span>
    <span class="token comment">// var result=await ctx.service.news.getNewsList()</span>
    <span class="token comment">// console.log(result)  </span>
    
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'http://www.api.com/cache'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 注意，要将模块暴露出去！！！</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UpdateCache<span class="token punctuation">;</span></code></pre>

<p>还可以简写为</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  schedule<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    interval<span class="token operator">:</span> <span class="token string">'1m'</span><span class="token punctuation">,</span> <span class="token comment">// 1 分钟间隔</span>
    type<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token comment">// 指定所有的 worker 都需要执行</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'http://www.api.com/cache'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      dataType<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>这个定时任务会在每一个 Worker 进程上每 1 分钟执行一次，将远程数据请求回来挂载到 <code>app.cache</code> 上。</p>
<h2 id="定时任务结合-egg-curl-及-cheerio-模块实现网站监控"><a href="#定时任务结合-egg-curl-及-cheerio-模块实现网站监控" class="headerlink" title="定时任务结合 egg.curl 及 cheerio 模块实现网站监控"></a>定时任务结合 egg.curl 及 cheerio 模块实现网站监控</h2><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//cheerio模块的使用</span>

<span class="token comment">/*
 1、安装cnpm i cheerio --save

 2、引入cheerio模块  
 
 3、加载要解析的内容
    const $ = cheerio.load('&lt;h2 class="title">Hello world&lt;/h2>')

 4、用法 
    $('title').html()   获取了要匹配的标题的内容

 5、获取的汉字是乱码 
    const $ = cheerio.load('&lt;h2 class="title">Hello world&lt;/h2>',&#123;decodeEntities: false&#125;)

*/</span>

<span class="token keyword">var</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        schedule<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            interval<span class="token operator">:</span> <span class="token string">'5s'</span><span class="token punctuation">,</span> <span class="token comment">// 1 分钟间隔</span>
            type<span class="token operator">:</span> <span class="token string">'all'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

        <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//1、抓取网站内容</span>
            <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">"https://news.baidu.com/"</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>spider<span class="token punctuation">.</span><span class="token function">requestUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> htmlData <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过 toString() 将 16进制流 转为 html代码</span>
            <span class="token comment">// console.log(htmlData);</span>

            <span class="token comment">//2、解析数据</span>
            <span class="token comment">//检测网站是否被篡改     检测网站是否挂掉</span>
            <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>htmlData<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> decodeEntities<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> title <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>title <span class="token operator">!=</span> <span class="token string">'百度新闻——海量中文资讯平台'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'网站挂掉了 或者被修改了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'正常'</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//获取到了hotnews下面所有的a标签的内容</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.hotnews a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="mysql安装-及-Navicat-使用"><a href="#mysql安装-及-Navicat-使用" class="headerlink" title="mysql安装 及 Navicat 使用"></a>mysql安装 及 Navicat 使用</h2><h3 id="Mysql-安装"><a href="#Mysql-安装" class="headerlink" title="Mysql 安装"></a>Mysql 安装</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/theLostLamb/article/details/78797643?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163652254716780265415311%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=163652254716780265415311&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-78797643.pc_search_result_control_group&utm_term=mysql+%E5%AE%89%E8%A3%85&spm=1018.2226.3001.4187">mysql安装教程</a></p>
<p>除了文章里说的，我们还可以将 bin 目录配置到环境变量中，以便可以在 任何目录下通过 <strong>命令行工具</strong> 都可以启动 mysql</p>
<h3 id="Navicat-使用"><a href="#Navicat-使用" class="headerlink" title="Navicat 使用"></a>Navicat 使用</h3><p>打开 Navicat 后，点击 连接 -&gt; mysql 后，输入连接名（localhost），密码。然后连接即可。</p>
<p><img src="/blogs/367fa608/56.jpg" loading="lazy"></p>
<p>右键点击 localhost 后，选择新建数据库，然后 像下图一样配置，便可新建数据库</p>
<p><img src="/blogs/367fa608/54.jpg" loading="lazy"></p>
<p>导出数据库表（以便他人使用）：</p>
<p><img src="/blogs/367fa608/55.jpg" loading="lazy"></p>
<h2 id="mysql数据库表的增、删、改、查"><a href="#mysql数据库表的增、删、改、查" class="headerlink" title="mysql数据库表的增、删、改、查"></a>mysql数据库表的增、删、改、查</h2><p><strong><code>数据库连接</code></strong></p>
<ol>
<li><code>mysql -u root -p</code></li>
<li>输入数据库密码</li>
</ol>
<hr>
<p><strong><code>显示当前存在数据库</code></strong></p>
<p><code>show databases;</code></p>
<hr>
<p>**<code>选中数据库</code>**（数据库选中后才能进行下面的操作）</p>
<p><code>use 数据库名;</code></p>
<hr>
<p><strong><code>查看当前数据库存在哪些表</code></strong></p>
<p><code>show tables;</code></p>
<hr>
<p><strong><code>查看一张表的所有内容</code></strong></p>
<p><code>select * from 表名;</code></p>
<hr>
<p><strong><code>查看一张表，并为其添加查询条件</code></strong></p>
<p><code>select * from 表名 where 查询条件;</code></p>
<hr>
<p><strong><code>查看一张表的数据总数</code></strong></p>
<p><code>select count(1) from 表名;</code></p>
<hr>
<p><strong><code>查看一张表，限制查询数</code></strong></p>
<p><code>select * from 表名 limit 查询数量;</code></p>
<hr>
<p><strong><code>查看一张表，限制查询数同时跳过某些数据</code></strong></p>
<p><code>select * from 表名 limit 跳过数量,查询数量;</code></p>
<hr>
<p><strong><code>查看一张表，并将查询结果按条件排序</code></strong></p>
<p><code>select * from 表名 order by 属性名1 asc/desc, 属性名2 asc/desc;</code></p>
<hr>
<p><strong><code>查看表的属性配置</code></strong></p>
<p><code>describe 表名;</code></p>
<hr>
<p><strong><code>创建数据库：</code></strong></p>
<p><code>create database 数据库名;</code></p>
<hr>
<p><strong><code>创建表:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> users<span class="token punctuation">(</span>
  username <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sex <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">status</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<hr>
<p><strong><code>给表中插入数据:</code></strong></p>
<p><code>insert into 表名(属性名1,属性名2,属性名3...) values (数据1,数据2,数据3...);</code></p>
<hr>
<p><strong><code>给表中插入多条数据:</code></strong></p>
<p><code>insert into 表名(属性名1,属性名2,属性名3...) values (数据1,数据2,数据3...),(数据1,数据2,数据3...);</code></p>
<hr>
<p><strong><code>修改表中数据:</code></strong></p>
<p><code>update 表名 set 属性名1=数据1,属性名2=数据2 where 修改所在行要满足的条件;</code></p>
<hr>
<p><strong><code>删除表中指定数据:</code></strong></p>
<p><code>delete from 表名 where 条件;</code></p>
<hr>
<p><strong><code>删除表：</code></strong></p>
<p><code>drop table 表名;</code></p>
<hr>
<p><strong><code>删除数据库:</code></strong></p>
<p><code>drop database 数据库名;</code></p>
<h2 id="mysql-字段常用数据类型"><a href="#mysql-字段常用数据类型" class="headerlink" title="mysql 字段常用数据类型"></a>mysql 字段常用数据类型</h2><p><strong>整数型</strong>：TINYINT，SMALLINT，INT，BIGINT </p>
<p><strong>浮点型</strong>：FLOAT，DOUBLE，DECIMAL(M,D) </p>
<p><strong>字符型</strong>：CHAR，VARCHAR </p>
<p><strong>备注型</strong>：TINYTEXT，TEXT，LONGTEXT</p>
<p><strong>日期型</strong>：DATETIME，DATE，TIMESTAMP（了解）</p>
<blockquote>
<p>整数型</p>
</blockquote>
<p><img src="/blogs/367fa608/57.jpg" loading="lazy"></p>
<p>TINYINT 最大长度 4 </p>
<p>SMALLINT 最大长度 6 </p>
<p>MEDIUMINT 最大长度 8 </p>
<p>int 最大长度是 11 位：如果在建表时不指定字段 int 类型的长度时，系统则默认生成长度为 11 的字段。11 也是 int 类型的最大长度，其中第一位表示符号+或者-，后面十位表示数字 。</p>
<p>BIGINT 最大长度 20</p>
<p>注意：int(M) 在 integer 数据类型中，M 表示最大显示宽度。在 int(M) 中，M 的值跟 int(M) 所占多少存储空间并无任何关系。和数字位数也无关系 int(3)、int(4)、int(8) 在磁盘上都是 占用 4 btyes 的存储空间。</p>
<p> int(11)，tinyint(1)，bigint(20)，后面的数字，不代表占用空间容量。而代表最小显示位数。 这个东西基本没有意义，除非你对字段指定 zerofill。 所以我们在设计 mysql 数据库时，建表时，mysql 会自动分配长度：int(11)、tinyint(4)、 smallint(6)、mediumint(9)、bigint(20)。 </p>
<p>所以，就用这些默认的显示长度就可以了。不用再去自己填长度，比如搞个 int(10)、tinyint(1) 之类的，基本没用。而且导致表的字段类型多样化。</p>
<blockquote>
<p>浮点型</p>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th>字节</th>
<th>最小值</th>
<th>最大值</th>
</tr>
</thead>
<tbody><tr>
<td>FLOAT</td>
<td>4</td>
<td>+-1.175494351E-38</td>
<td>+-3.402823466E+38</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8</td>
<td>+-2.2250738585072014E-308</td>
<td>+-1.7976931348623157E+308</td>
</tr>
<tr>
<td>DECIMAL</td>
<td>可变</td>
<td>它的取值范围可变。</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>字符串型</p>
</blockquote>
<p><img src="/blogs/367fa608/58.jpg" loading="lazy"></p>
<p>varchar 使用额外的 1-2 字节内来存储值长度，列长度&lt;=255 使用 1 字节保存，其它情况使用 2 字节保存。例如 varchar(10)会占用 11 字节存储空间，varchar(500)会占用 502 字节存 储空间。</p>
<p>varchar 会根据数据的长度 动态 分配存储需求，而 char 会固定存储需求。</p>
<p> <strong>varchar 最大长度可以是多少？</strong></p>
<p> 根据字符集，字符类型若为 gbk，每个汉字占用 2 个字节，最大长度不能超过 65535/2 =32766； 字符类型若为 utf8，每个汉字最多占用 3 个字节，最大长度不能超过 65535/3 =21845，若超过这个限制，则会自动将 varchar 类型转为 mediumtext 或 longtext,</p>
<blockquote>
<p>备注型</p>
</blockquote>
<p><img src="/blogs/367fa608/59.jpg" loading="lazy"></p>
<blockquote>
<p>日期型</p>
</blockquote>
<table>
<thead>
<tr>
<th>列类型</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>DATETIME</td>
<td>‘0000-00-00 00:00:00’</td>
</tr>
<tr>
<td>DATE</td>
<td>‘0000-00-00’</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>00000000000000</td>
</tr>
<tr>
<td>TIME</td>
<td>‘00:00:00’</td>
</tr>
<tr>
<td>YEAR</td>
<td>0000</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>实际项目中我们存储日期用的都是 int 类型的时间戳。</p>
<h2 id="mysql-查询语句详解"><a href="#mysql-查询语句详解" class="headerlink" title="mysql 查询语句详解"></a>mysql 查询语句详解</h2><h3 id="WHERE-表达式的常用运算符"><a href="#WHERE-表达式的常用运算符" class="headerlink" title="WHERE 表达式的常用运算符"></a>WHERE 表达式的常用运算符</h3><p><img src="/blogs/367fa608/60.jpg" loading="lazy"></p>
<p>**<code>查找 email 属性不为空的数据：</code>**（注意：此处的空为一开始创建数据时未赋值导致的空，并非后面修改为空）</p>
<p><code>select * from class where email is not null;</code></p>
<hr>
<p><strong><code>查找 email 属性为空的数据：</code></strong></p>
<p><code>select * from class where email is null;</code></p>
<hr>
<p><strong><code>查找 email 属性为空 或 email 值为空的数据:</code></strong></p>
<p><code> select * from class where email is null or email=&quot;&quot;;</code></p>
<hr>
<p><strong><code>查找成绩大于等于 70 小于等于 90 的数据:</code></strong></p>
<p><code>select * from class where score&gt;=70 and score&lt;=90;</code></p>
<p><code>select * from class where score between 70 and 90;</code></p>
<hr>
<p><strong><code>查找成绩不在 70 和 90 之间的数据:</code></strong></p>
<p><code>select * from class where score&lt;70 or score&gt;90;</code></p>
<p><code>select * from class where score not between 70 and 90;</code></p>
<hr>
<p><strong><code>查找 score 为 89 和 98 的数据:</code></strong></p>
<p><code>select * from class where score in (89,98);</code></p>
<hr>
<p><strong><code>查找 score 不是 89 和 98 的数据:</code></strong></p>
<p><strong><code>select * from class where score not in (89,98);</code></strong></p>
<hr>
<p><strong><code>模糊查询 - 查询 email 中包含 qq字段 的:</code></strong></p>
<p><code>select * from class where email like &quot;%qq%&quot;;</code></p>
<hr>
<p><strong><code>模糊查询 - 查询 email 中以 ja 开头的:</code></strong></p>
<p><code>select * from class where email like &quot;ja%&quot;;</code></p>
<hr>
<p><strong><code>模糊查询 - 查询 email 中以 163.com 结尾的:</code></strong></p>
<p><code>select * from class where email like &quot;%163.com&quot;;</code></p>
<hr>
<p><strong><code>模糊查询 - 查询 email 中不是以 163.com 结尾的:</code></strong></p>
<p><code>select * from class where email not like &quot;%163.com&quot;;</code></p>
<hr>
<h3 id="Mysql-分组函数"><a href="#Mysql-分组函数" class="headerlink" title="Mysql 分组函数"></a>Mysql 分组函数</h3><p><img src="/blogs/367fa608/61.jpg" loading="lazy"></p>
<p><strong><code>统计班级的平均分:</code></strong></p>
<p><code>select avg(score) from class;</code></p>
<hr>
<p><strong><code>统计班级一共多少人:</code></strong></p>
<p><code>select count(1) from class;</code></p>
<hr>
<p><strong><code>找出这个班成绩最高的学生的信息:</code></strong></p>
<p><code>select * from class where score in (select max(score) from class); </code></p>
<hr>
<p><strong><code>找出这个班成绩最低的学生的信息:</code></strong></p>
<p><code>select * from class where score in (select min(score) from class); </code></p>
<hr>
<p><strong><code>统计这个班的总分:</code></strong></p>
<p><code>select sum(score) from class;</code></p>
<h3 id="Mysql-别名"><a href="#Mysql-别名" class="headerlink" title="Mysql 别名"></a>Mysql 别名</h3><p>通过 属性名 as 别名 为查询到的属性起别名。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> name <span class="token keyword">as</span> a <span class="token keyword">from</span> class<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">as</span> minscore <span class="token keyword">from</span> class<span class="token punctuation">;</span></code></pre>

<h2 id="mysql-表的三种关系及查询进阶"><a href="#mysql-表的三种关系及查询进阶" class="headerlink" title="mysql 表的三种关系及查询进阶"></a>mysql 表的三种关系及查询进阶</h2><p>表与表之间一般存在三种关系：一对一、一对多、多对多。</p>
<h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>查找一个文章并显示文章分类（文章表对于文章分类表来说是一对一的）</p>
<p><img src="/blogs/367fa608/62.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/63.jpg" loading="lazy"></p>
<p><code>select article.id as id,article.title as title,article_cate.title as cate from article,article_cate Where article.cate_id=article_cate.id</code></p>
<p><code>select article.id as id,article.title as title,article_cate.title as cate from article INNER JOIN article_cate ON article_cate.id=article.cate_id</code></p>
<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><p>查看国际分类下的所有文章（文章分类表对于文章表来说是一对多的）</p>
<p><code>select * from article where cate_id=2</code></p>
<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>一个学生可以选修多门课程，一门课程也可以被多个学生选修。此时需要一个表将学生表与课程表进行 <strong>关联</strong>。</p>
<p><img src="/blogs/367fa608/64.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/65.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/66.jpg" loading="lazy"></p>
<p><strong><code>查询张三(id为1)选修了哪些课程</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 普通查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> lesson <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> lesson_id <span class="token keyword">from</span> lesson_student <span class="token keyword">where</span> student_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 笛卡尔积查询</span>
<span class="token keyword">select</span> lesson<span class="token punctuation">.</span>id <span class="token keyword">as</span> id<span class="token punctuation">,</span>lesson<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">from</span> lesson<span class="token punctuation">,</span>lesson_student <span class="token keyword">where</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span>lesson<span class="token punctuation">.</span>id <span class="token operator">and</span> lesson_student<span class="token punctuation">.</span>student_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 内关联查询</span>
<span class="token keyword">select</span> lesson<span class="token punctuation">.</span>id <span class="token keyword">as</span> id<span class="token punctuation">,</span>lesson<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">from</span> lesson <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> lesson_student <span class="token keyword">ON</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span>lesson<span class="token punctuation">.</span>id <span class="token operator">and</span> lesson_student<span class="token punctuation">.</span>student_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>查询哪些人修改了 java(id为2)</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> student_id <span class="token keyword">from</span> lesson_student <span class="token keyword">where</span> lesson_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>


<span class="token keyword">select</span> student<span class="token punctuation">.</span>id <span class="token keyword">as</span> id<span class="token punctuation">,</span>student<span class="token punctuation">.</span>number <span class="token keyword">as</span> number<span class="token punctuation">,</span>student<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">from</span> student<span class="token punctuation">,</span>lesson_student <span class="token keyword">where</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> lesson_student<span class="token punctuation">.</span>student_id<span class="token operator">=</span>student<span class="token punctuation">.</span>id<span class="token punctuation">;</span>


<span class="token keyword">select</span> student<span class="token punctuation">.</span>id <span class="token keyword">as</span> id<span class="token punctuation">,</span>student<span class="token punctuation">.</span>number <span class="token keyword">as</span> number<span class="token punctuation">,</span>student<span class="token punctuation">.</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">from</span> student <span class="token keyword">inner</span> <span class="token keyword">join</span> lesson_student <span class="token keyword">on</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> lesson_student<span class="token punctuation">.</span>student_id<span class="token operator">=</span>student<span class="token punctuation">.</span>id<span class="token punctuation">;</span></code></pre>



<h3 id="Mysql-笛卡尔积连接、内连接、左外连接、右外连接"><a href="#Mysql-笛卡尔积连接、内连接、左外连接、右外连接" class="headerlink" title="Mysql 笛卡尔积连接、内连接、左外连接、右外连接"></a>Mysql 笛卡尔积连接、内连接、左外连接、右外连接</h3><p>查询数据的时候能不用连接语句尽量不要使用，笛卡尔积连接查询速度最慢，项目中用的比 较多的是内连接。</p>
<p><strong>笛卡尔积连接：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student<span class="token punctuation">,</span>lesson_student <span class="token keyword">where</span> student<span class="token punctuation">.</span>id<span class="token operator">=</span>lesson_student<span class="token punctuation">.</span>student_id <span class="token operator">AND</span>
lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span></code></pre>

<p><strong>内连接：</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> lesson_student <span class="token keyword">ON</span> student<span class="token punctuation">.</span>id<span class="token operator">=</span>lesson_student<span class="token punctuation">.</span>student_id
<span class="token operator">AND</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span></code></pre>

<p><strong>左外连接：</strong></p>
<p>左外连接会将 左边表全部输出，右边表没关联值为空，有关联则有值</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> lesson_student <span class="token keyword">ON</span> student<span class="token punctuation">.</span>id<span class="token operator">=</span>lesson_student<span class="token punctuation">.</span>student_id <span class="token operator">AND</span>
lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span></code></pre>

<p><strong>右外连接：</strong></p>
<p>右外连接会将 右边表全部输出，左边表没关联值为空，有关联则有值</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> lesson_student <span class="token keyword">ON</span> student<span class="token punctuation">.</span>id<span class="token operator">=</span>lesson_student<span class="token punctuation">.</span>student_id
<span class="token operator">AND</span> lesson_student<span class="token punctuation">.</span>lesson_id<span class="token operator">=</span><span class="token number">2</span></code></pre>



<h2 id="mysql-表的索引"><a href="#mysql-表的索引" class="headerlink" title="mysql 表的索引"></a>mysql 表的索引</h2><p>MySQL 索引的建立对于 MySQL 的高效运行是很重要的，索引可以大大提高 MySQL 的检索速度。 如果没有索引，执行查询时候必须从第一条记录开始，扫描整个表的记录，直到符合要求的记录。如果有了索引，mysql 无需扫描任何记录即可顺序找到目标记录的位置。简单说来， 索引就是提高查 找数据速度，数据量越多，效果越明显。</p>
<p>Mysql 中常见的索引类型有<strong>普通索引</strong>、<strong>唯一索引</strong>、全文索引、空间索引</p>
<p><strong><code>快速创建数据：</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> username <span class="token keyword">from</span> users</code></pre>

<p><strong><code>创建普通索引：</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> indexName <span class="token keyword">ON</span> mytable<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> 索引名 <span class="token keyword">ON</span> 表名<span class="token punctuation">(</span>属性名<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> index_name <span class="token keyword">on</span> class<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> index_username <span class="token keyword">on</span> users<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>查看索引:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> table_name
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> 表名</code></pre>

<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> class<span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> nav<span class="token punctuation">;</span></code></pre>

<p><strong><code>删除索引:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">index</span> index_name <span class="token keyword">on</span> table_name<span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> 索引名 <span class="token keyword">on</span> 表名<span class="token punctuation">;</span></code></pre>

<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">index</span> index_username <span class="token keyword">on</span> users<span class="token punctuation">;</span></code></pre>

<p><strong><code>创建唯一索引（主键是一种唯一索引）:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">unique</span> <span class="token keyword">index</span> index_name <span class="token keyword">on</span> class<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>索引的另一种创建和删除的方式:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">index</span> index_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">add</span> <span class="token keyword">index</span> 索引名<span class="token punctuation">(</span>属性名<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> users <span class="token keyword">add</span> <span class="token keyword">index</span> index_username<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">add</span> <span class="token keyword">unique</span> index_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> class <span class="token keyword">drop</span> <span class="token keyword">index</span> index_name<span class="token punctuation">;</span></code></pre>

<p><strong><code>查看影响行数:</code></strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">desc</span> 数据库语句<span class="token punctuation">;</span>
<span class="token keyword">desc</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">"wangwu123"</span></code></pre>

<p><strong><code>用可视化工具创建索引：</code></strong></p>
<p><img src="/blogs/367fa608/67.jpg" loading="lazy"></p>
<p><strong>1、索引可以让我们的查询速度变的非常快</strong></p>
<p><strong>2、索引也会导致增加、修改数据的时候要比以前稍微慢一点，因为增加修改数据还要维护索引。</strong></p>
<h2 id="mysql-事务与锁定"><a href="#mysql-事务与锁定" class="headerlink" title="mysql 事务与锁定"></a>mysql 事务与锁定</h2><h3 id="mysql-事务"><a href="#mysql-事务" class="headerlink" title="mysql 事务"></a>mysql 事务</h3><p>事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。</p>
<p><img src="/blogs/367fa608/68.jpg" loading="lazy"></p>
<p><img src="/blogs/367fa608/69.jpg" loading="lazy"></p>
<h3 id="mysql-锁"><a href="#mysql-锁" class="headerlink" title="mysql 锁"></a>mysql 锁</h3><p>Mysql 中的锁有**<code>表级锁</code><strong>和</strong><code>行级锁</code>**，这里主要给讲最常用的表级锁。</p>
<ol>
<li>添加读锁 可以并发读，但是不能并发写（都可以读取，但是都不能写），读锁期间，没释放锁之前不能进行写操作。 </li>
</ol>
<p>使用场景：读取结果集的最新版本，同时防止其他事务产生更新该结果集 主要用在需要数据依存关系时确认某行记录是否存在，并确保没有人对这个记录进行 UPDATE 或者 DELETE 操作</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">lock</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">read</span><span class="token punctuation">;</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> 表名 rea<span class="token punctuation">;</span>

<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span></code></pre>

<ol start="2">
<li>添加写锁 只有锁表的用户可以进行读写操作（锁表用户可以读和写，其它用户不能读也不能写），其他用户不行 （并发下对商品库存的操作）</li>
</ol>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">lock</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">write</span><span class="token punctuation">;</span>
<span class="token keyword">lock</span> <span class="token keyword">table</span> 表名 <span class="token keyword">write</span><span class="token punctuation">;</span>

<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span></code></pre>

<h2 id="egg-js中使用egg-mysql操作mysql数据库"><a href="#egg-js中使用egg-mysql操作mysql数据库" class="headerlink" title="egg.js中使用egg-mysql操作mysql数据库"></a>egg.js中使用egg-mysql操作mysql数据库</h2><ol>
<li>安装模块：</li>
</ol>
<pre class="language-none"><code class="language-none">cnpm i egg-mysql --save</code></pre>

<ol start="2">
<li>配置模块：</li>
</ol>
<p><strong><code>config/plugin.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  mysql<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-mysql'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> userConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  mysql<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// database configuration</span>
    client<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// host</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      <span class="token comment">// port</span>
      port<span class="token operator">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
      <span class="token comment">// username</span>
      user<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
      <span class="token comment">// password</span>
      password<span class="token operator">:</span> <span class="token string">'admin123'</span><span class="token punctuation">,</span>
      <span class="token comment">// database</span>
      database<span class="token operator">:</span> <span class="token string">'school'</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token comment">// load into app, default is open</span>
    app<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// load into agent, default is close</span>
    agent<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ol start="3">
<li>使用模块：</li>
</ol>
<p><strong><code>controller/user.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 1、获取用户表的数据</span>
        <span class="token comment">// get 一次只能查询一条数据</span>
        <span class="token comment">/* var result = await this.app.mysql.get('user', &#123; "id": 3 &#125;); */</span>

        <span class="token comment">// 2. 获取全部数据 指定条件</span>
        <span class="token comment">/* const result = await this.app.mysql.select('user', &#123;
            // where: &#123; "id": 3 &#125;,
            // limit: 2,
            orders: [['id', 'desc']]
        &#125;) */</span>

        <span class="token comment">// 3.增加数据 </span>
        <span class="token comment">/* const result = await this.app.mysql.insert('user', &#123; username: 'xxc', balance: '123' &#125;) */</span>

        <span class="token comment">// 4.修改数据（根据主键修改）</span>

        <span class="token comment">/* var userInfo = &#123;
            id: 4,
            username: '小六子'
        &#125;
        // id 为 4 的数据的 username 会变为 ‘小六子’
        var result = await this.app.mysql.update('user', userInfo) */</span>

        <span class="token comment">// 5. 修改数据（执行 sql 语句修改数据，可能会修改多行数据）</span>
        <span class="token comment">// var result = await this.app.mysql.query('update user set username=? where balance=?', ['李四', 100])</span>

        <span class="token comment">// 6. 删除数据</span>
        <span class="token comment">/* const result = await this.app.mysql.delete('user', &#123;
            username: 'xxc'
        &#125;) */</span>

        <span class="token comment">// 7.通过 sql 语句查询数据</span>
        <span class="token comment">/* var myId = 3;
        var result = await this.app.mysql.query('select * from user where id=?', [myId]); */</span>

        <span class="token comment">// 8.mysql 事务 数据库事务（Data Transaction）,是指作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。</span>
        <span class="token comment">/**
         * 两人转账的操作，A给B转账 10 元
         *      1. 需要更新 user 表，让A用户的 money -10        A总共有5元  （执行失败）异常
         *      2. 需要更新 user 表，让B用户的 money +10        （执行成功）
         * 
         * 事务：
         *      如果失败执行回滚操作（如果有一个失败），如果成功执行提交操作（真正的增加到数据库里面）
         */</span>

        <span class="token keyword">const</span> conn <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// await conn.insert(table,row1);</span>
            <span class="token comment">// await coon.update(table,row2);</span>

            <span class="token comment">// 增加数据操作</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token string">'哈哈哈哈'</span><span class="token punctuation">,</span> <span class="token string">'balance'</span><span class="token operator">:</span> <span class="token string">'123456'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            window<span class="token punctuation">.</span><span class="token function">xxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 方法不存在</span>

            <span class="token comment">// 修改数据操作</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'update user set username=? where id=?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'jmz'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="egg-js-中使用-Sequelize-ORM-框架-操作-数据库-增删改查"><a href="#egg-js-中使用-Sequelize-ORM-框架-操作-数据库-增删改查" class="headerlink" title="egg.js 中使用 Sequelize ORM 框架 操作 数据库 - 增删改查"></a>egg.js 中使用 Sequelize ORM 框架 操作 数据库 - 增删改查</h2><p>前面的章节中，我们介绍了如何在框架中通过 egg-mysql 插件来访问数据库。而在一些较 为复杂的应用中，我们可能会需要一个 ORM 框架来帮助我们管理数据层的代码。而在 Node.js 社区中，sequelize 是一个广泛使用的 ORM 框架，它支持 MySQL、SQLite 和 MSSQL 、PostgreSQL 等多个数据源。下面我们主要给大家讲讲 sequelize 结合 MySQL 的使 用。</p>
<ol>
<li>安装 模块：</li>
</ol>
<pre class="language-none"><code class="language-none">cnpm i egg-sequelize mysql2 --save</code></pre>

<ol start="2">
<li>配置模块：</li>
</ol>
<p><strong><code>config/plugin.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 配置插件使用</span>
  sequelize<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-sequelize'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>config/config.default.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> userConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 配置数据库连接</span>
  sequelize<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token operator">:</span> <span class="token string">'eggjs'</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">"admin123"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ol start="3">
<li>新建数据库及表：</li>
</ol>
<p><img src="/blogs/367fa608/70.jpg" loading="lazy"></p>
<ol start="4">
<li>新建 <strong><code>model/user.js</code></strong></li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token comment">// 定义数据库模型</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>		<span class="token comment">// 此处命名为 user，则数据库中表名应为 users。</span>
        id<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
        sex<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        created_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
        updated_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ol start="5">
<li>在控制器中使用 模型：</li>
</ol>
<p><strong><code>controller/home.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 查询数据</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// const userList = await ctx.model.User.findAll();</span>

    <span class="token comment">// 查询指定字段</span>
    <span class="token comment">// const userList = await ctx.model.User.findAll(&#123; attributes: ['id', 'username'] &#125;)</span>

    <span class="token comment">// 查询条件</span>
    <span class="token comment">// const userList = await ctx.model.User.findAll(&#123; attributes: ['id', 'username'], where: &#123; id: 2 &#125; &#125;)</span>
    <span class="token comment">// const userList = await ctx.model.User.findAll(&#123; attributes: ['id', 'username'], where: &#123; username: '张三' &#125; &#125;)</span>


    <span class="token comment">// 限制查询数据</span>
    <span class="token comment">// limit 表示限制几条数据，offset 表示跳过几条数据。</span>
    <span class="token keyword">const</span> userList <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> limit<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> order<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"desc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> userList<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 增加数据</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token string">'jmz'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span> sex<span class="token operator">:</span> <span class="token string">"男"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 根据主键查找数据</span>
  <span class="token keyword">async</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 修改数据</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token string">"username"</span><span class="token operator">:</span> <span class="token string">"王麻子"</span><span class="token punctuation">,</span> <span class="token string">"sex"</span><span class="token operator">:</span> <span class="token string">"女"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"修改成功"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 删除数据</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      user<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"删除成功"</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="Egg中使用Sequelize-ORM框架操作Mysql-进行关联查询"><a href="#Egg中使用Sequelize-ORM框架操作Mysql-进行关联查询" class="headerlink" title="Egg中使用Sequelize ORM框架操作Mysql-进行关联查询"></a>Egg中使用Sequelize ORM框架操作Mysql-进行关联查询</h2><h3 id="1-对-1-hasOne-和-belongsTo"><a href="#1-对-1-hasOne-和-belongsTo" class="headerlink" title="1 对 1 (hasOne 和 belongsTo)"></a>1 对 1 (hasOne 和 belongsTo)</h3><p><strong><code>model/article_cate.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> ArticleCate <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'article_cate'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token constant">INTEGER</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">//关闭时间戳</span>
    tableName<span class="token operator">:</span> <span class="token string">'article_cate'</span>    <span class="token comment">//配置表名称 </span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ArticleCate<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1对1</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> foreignKey<span class="token operator">:</span> <span class="token string">'cateId'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> ArticleCate<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>model/article.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> Article <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    cateId<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 下划线属性此处要写成驼峰形式</span>
    state<span class="token operator">:</span> <span class="token constant">DATE</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    tableName<span class="token operator">:</span> <span class="token string">'article'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  Article<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1对1</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> foreignKey<span class="token operator">:</span> <span class="token string">'cateId'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> Article<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>controller/article.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ArticleController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 查询 1 对 1</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      include<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>



<p><img src="/blogs/367fa608/71.jpg" loading="lazy"></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ArticleController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">//查询数据 1对1</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      include<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img src="/blogs/367fa608/72.jpg" loading="lazy"></p>
<h3 id="1-对-多-hasMany-和-belongsTo"><a href="#1-对-多-hasMany-和-belongsTo" class="headerlink" title="1 对 多 (hasMany 和 belongsTo)"></a>1 对 多 (hasMany 和 belongsTo)</h3><p><strong><code>model/article.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> Article <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    cateId<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 下划线属性此处要写成驼峰形式</span>
    state<span class="token operator">:</span> <span class="token constant">DATE</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    tableName<span class="token operator">:</span> <span class="token string">'article'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Article<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> foreignKey<span class="token operator">:</span> <span class="token string">'cateId'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> Article<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>model/article_cate.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> ArticleCate <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'article_cate'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    id<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token constant">INTEGER</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">//关闭时间戳</span>
    tableName<span class="token operator">:</span> <span class="token string">'article_cate'</span>    <span class="token comment">//配置表名称 </span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ArticleCate<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1对多</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> foreignKey<span class="token operator">:</span> <span class="token string">'cateId'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> ArticleCate<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><strong><code>controller/article.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ArticleController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 查询 1 对 多</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleCate<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      include<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img src="/blogs/367fa608/73.jpg" loading="lazy"></p>
<h3 id="多对多-（belongsToMany"><a href="#多对多-（belongsToMany" class="headerlink" title="多对多 （belongsToMany)"></a>多对多 （belongsToMany)</h3><p><strong><code>model/lesson_student.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">INTEGER</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>
 
    <span class="token keyword">const</span> LessonStudent <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'lesson_student'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        lessonId<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            primaryKey<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        studentId<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            primaryKey<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
        timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        tableName<span class="token operator">:</span> <span class="token string">'lesson_student'</span>    
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> LessonStudent<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>model/lesson.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">STRING</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">const</span> Lesson <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'lesson'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        id<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span>
            allowNull<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        tableName<span class="token operator">:</span> <span class="token string">'lesson'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    Lesson<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//一门课程可以被多个学生选修</span>
        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Lesson<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Student<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            through<span class="token operator">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>LessonStudent<span class="token punctuation">,</span>   <span class="token comment">// 此处要用大写</span>
            foreignKey<span class="token operator">:</span> <span class="token string">'lessonId'</span><span class="token punctuation">,</span><span class="token comment">//注意写法 </span>
            otherKey<span class="token operator">:</span> <span class="token string">'studentId'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> Lesson<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>model/student.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">const</span> Student <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'student'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        id<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            primaryKey<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        number<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span>
            allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            type<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            allowNull<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        timestamps<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        tableName<span class="token operator">:</span> <span class="token string">'student'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Student<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//一个学生可以选修多门课程 </span>
        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Lesson<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            through<span class="token operator">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>LessonStudent<span class="token punctuation">,</span>       <span class="token comment">// 通过学生选课表管理</span>
            foreignKey<span class="token operator">:</span> <span class="token string">'studentId'</span><span class="token punctuation">,</span><span class="token comment">//注意写法（下划线改为驼峰）</span>
            otherKey<span class="token operator">:</span> <span class="token string">'lessonId'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> Student<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong><code>controller/article.js</code></strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">  <span class="token comment">//查询数据  多对多</span>
  <span class="token keyword">async</span> <span class="token function">showAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ctx <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">//课程有哪些学生选修</span>
    <span class="token comment">// let result = await ctx.model.Lesson.findAll(&#123;</span>
    <span class="token comment">//   include: &#123;</span>
    <span class="token comment">//     model: ctx.model.Student</span>
    <span class="token comment">//   &#125;</span>
    <span class="token comment">// &#125;);</span>


    <span class="token comment">//每个学生选修了哪些课程</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Student<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      include<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        model<span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Lesson
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

</div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>语轻星子</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://xxcijmz.top/blogs/367fa608/" title="Serverless+vue3+eggsjs 无人点餐项目">https://xxcijmz.top/blogs/367fa608/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/blogs/28bc8086/" rel="prev" title="Serverless-vue3-eggsjs-无人点餐项目(二)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Serverless-vue3-eggsjs-无人点餐项目(二)</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/blogs/joiasdd/" rel="next" title="仿微信项目开发(二)"><span class="post-nav-text">仿微信项目开发(二)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div><div id="valine-container"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js", () => {
  const valineConfig = {"enable":true,"appId":"MnqOxUn1tp2XfaBiRJqcPNC3-MdYXbMMI","appKey":"BUJAYYUt5IhdIDVVvHH8aHMx","placeholder":"来与我一起讨论吧","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = "/blogs/367fa608/"
  new Valine(valineConfig)
}, window.Valine);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">闽ICP备2021017107号-1</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 语轻星子</span></div><div class="live_time"><span>本博客已运行：</span><span id="display_live_time"></span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-09-23T00:03:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#5698c3" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.9},"dialog":{"enable":true},"log":false});</script></body></html>