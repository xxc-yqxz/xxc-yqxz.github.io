<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#5698c3"><meta name="author" content="语轻星子"><meta name="copyright" content="语轻星子"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>虚拟DOM的实现原理 | 轻语馆</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#5698c3"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"xxcijmz.top","root":"/","title":"轻语馆","version":"1.6.2","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"algolia":{"appID":"I6Q6TFSWKC","apiKey":"8299a265813c86a465cc32755761abc9","indexName":"blogs","hits":{"per_page":10}}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="stylesheet" href="/css/content.css"><meta name="description" content="Virtual DOM什么是Virtual DOM Virtual DOM(虚拟DOM)，是由普通的JS对象来描述DOM对象  真实DOM成员  通过以上代码输出真实DOM成员：     ​            可以看到真实DOM中的数据是非常多的  使用Virtual DOM来描述真实DOM  虚拟DOM的创建比真实DOM的成本要小很多   为什么要使用Virtual DOM 前端应用开发原先">
<meta property="og:type" content="article">
<meta property="og:title" content="虚拟DOM的实现原理">
<meta property="og:url" content="https://xxcijmz.top/blogs/1d7d6fc9/index.html">
<meta property="og:site_name" content="轻语馆">
<meta property="og:description" content="Virtual DOM什么是Virtual DOM Virtual DOM(虚拟DOM)，是由普通的JS对象来描述DOM对象  真实DOM成员  通过以上代码输出真实DOM成员：     ​            可以看到真实DOM中的数据是非常多的  使用Virtual DOM来描述真实DOM  虚拟DOM的创建比真实DOM的成本要小很多   为什么要使用Virtual DOM 前端应用开发原先">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/1.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/2.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/3.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/4.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/5.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/6.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/7.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/8.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/13.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/9.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/10.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/12.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/14.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/15.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/16.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/17.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/18.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/19.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/20.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/21.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/22.jpg">
<meta property="og:image" content="https://xxcijmz.top/blogs/1d7d6fc9/23.jpg">
<meta property="article:published_time" content="2021-10-13T06:40:23.000Z">
<meta property="article:modified_time" content="2021-12-05T12:15:37.395Z">
<meta property="article:author" content="语轻星子">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xxcijmz.top/blogs/1d7d6fc9/1.jpg"><script src="/js/ui/mode.js"></script></head><body><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="语轻星子"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/xxc-yqxz/xxc-yqxz.github.io/images/avatar.jpg" alt="语轻星子"></a><div class="site-author-name"><a href="/about/">语轻星子</a></div><span class="site-name">轻语馆</span><sub class="site-subtitle">我也会加油，所以你也要加油，这是约定</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">36</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">9</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://github.com/xxc-yqxz/xxc-yqxz.github.io" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=894043590&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=1379764422" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/269921139" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Virtual-DOM"><span class="toc-number">1.</span> <span class="toc-text">Virtual DOM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFVirtual-DOM"><span class="toc-number">1.1.</span> <span class="toc-text">什么是Virtual DOM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8Virtual-DOM"><span class="toc-number">1.2.</span> <span class="toc-text">为什么要使用Virtual DOM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E4%BD%9C%E7%94%A8%E5%92%8C%E8%99%9A%E6%8B%9FDOM%E5%BA%93"><span class="toc-number">1.3.</span> <span class="toc-text">虚拟DOM的作用和虚拟DOM库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">虚拟DOM的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9FDOM%E5%BA%93"><span class="toc-number">1.3.2.</span> <span class="toc-text">虚拟DOM库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snabbdom-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Snabbdom 基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5Snabbdom"><span class="toc-number">2.2.</span> <span class="toc-text">导入Snabbdom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1"><span class="toc-number">2.3.</span> <span class="toc-text">案例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2"><span class="toc-number">2.4.</span> <span class="toc-text">案例2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97"><span class="toc-number">2.5.</span> <span class="toc-text">模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snabbdom%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">Snabbdom源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E6%BA%90%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">如何学习源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snabbdom%E7%9A%84%E6%A0%B8%E5%BF%83"><span class="toc-number">3.2.</span> <span class="toc-text">Snabbdom的核心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">h函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VNode%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.2.</span> <span class="toc-text">VNode函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#patch%E6%95%B4%E4%BD%93%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.2.3.</span> <span class="toc-text">patch整体过程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.4.</span> <span class="toc-text">init函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#patch%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.5.</span> <span class="toc-text">patch函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createElm-%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.6.</span> <span class="toc-text">createElm 函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89hook%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.7.</span> <span class="toc-text">用户如何定义hook函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#removeVnodes-%E5%92%8C-addVnodes"><span class="toc-number">3.2.8.</span> <span class="toc-text">removeVnodes 和 addVnodes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#patchVnode"><span class="toc-number">3.2.9.</span> <span class="toc-text">patchVnode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateChildren%E6%95%B4%E4%BD%93%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.10.</span> <span class="toc-text">updateChildren整体过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#updateChildren%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.11.</span> <span class="toc-text">updateChildren函数介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Key-%E7%9A%84%E6%84%8F%E4%B9%89"><span class="toc-number">3.2.12.</span> <span class="toc-text">Key 的意义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.2.13.</span> <span class="toc-text">key 的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Diff-%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.14.</span> <span class="toc-text">Diff 过程</span></a></li></ol></li></ol></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/JS/" style="font-size: 26.4px; color: #8cbbd1">JS</a> <a href="/tags/Vue/" style="font-size: 30px; color: #8abcd1">Vue</a> <a href="/tags/eggjs/" style="font-size: 19.2px; color: #8fb8d0">eggjs</a> <a href="/tags/serverless/" style="font-size: 19.2px; color: #8fb8d0">serverless</a> <a href="/tags/uniapp/" style="font-size: 22.8px; color: #8eb9d0">uniapp</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15.6px; color: #91b6cf">小程序</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 15.6px; color: #91b6cf">工程化</a> <a href="/tags/%E6%97%A5%E8%AE%B0/" style="font-size: 12px; color: #93b5cf">日记</a> <a href="/tags/%E6%A6%82%E5%BF%B5/" style="font-size: 22.8px; color: #8eb9d0">概念</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 12px; color: #93b5cf">部署</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://xxcijmz.top/blogs/1d7d6fc9/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="语轻星子"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="轻语馆"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">虚拟DOM的实现原理</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-10-13 14:40:23" itemprop="dateCreated datePublished" datetime="2021-10-13T14:40:23+08:00">2021-10-13</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-12-05 20:15:37" itemprop="dateModified" datetime="2021-12-05T20:15:37+08:00">2021-12-05</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">9.2k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">38m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E5%89%8D%E7%AB%AF/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">大前端</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%A4%A7%E5%89%8D%E7%AB%AF/Vue/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Vue</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Vue/" style="--text-color:#4fc08d"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Vue</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#5698c3;"><h2 id="Virtual-DOM"><a href="#Virtual-DOM" class="headerlink" title="Virtual DOM"></a>Virtual DOM</h2><h3 id="什么是Virtual-DOM"><a href="#什么是Virtual-DOM" class="headerlink" title="什么是Virtual DOM"></a>什么是Virtual DOM</h3><ul>
<li><p>Virtual DOM(虚拟DOM)，是由普通的JS对象来描述DOM对象</p>
</li>
<li><p>真实DOM成员</p>
<p><img src="/blogs/1d7d6fc9/1.jpg" loading="lazy"></p>
<p>通过以上代码输出真实DOM成员：</p>
<img src="/blogs/1d7d6fc9/2.jpg" style="zoom:50%;" loading="lazy"></li>
</ul>
<img src="/blogs/1d7d6fc9/3.jpg" style="zoom:50%;" loading="lazy">

<p>​            可以看到真实DOM中的数据是非常多的</p>
<ul>
<li><p>使用Virtual DOM来描述真实DOM</p>
<p><img src="/blogs/1d7d6fc9/4.jpg" loading="lazy"></p>
<p>虚拟DOM的创建比真实DOM的成本要小很多</p>
</li>
</ul>
<h3 id="为什么要使用Virtual-DOM"><a href="#为什么要使用Virtual-DOM" class="headerlink" title="为什么要使用Virtual DOM"></a>为什么要使用Virtual DOM</h3><ul>
<li><p>前端应用开发原先需要手动操作DOM，还需要考虑浏览器兼容性等问题，后来有了jQuery，可以简化DOM操作，但随着应用复杂程度的提升，DOM操作也变得复杂。</p>
</li>
<li><p>为了降低开发复杂程度，出现了MVVM框架，解决了视图和状态同步问题。</p>
</li>
<li><p>过去模板引擎可以简化视图操作，但是没办法跟踪状态，只好把页面中的视图全部删除再重新创建。</p>
</li>
<li><p>为了解决状态跟踪的问题，出现了虚拟DOM，虚拟DOM在状态改变的时候，不需要立即更新DOM，只需要创建一个虚拟DOM树来描述真实的DOM树，虚拟DOM内部会根据diff算法来找到状态的差异，从而弄清如何有效的更新真实的DOM。</p>
</li>
<li><p>虚拟DOM可以维护程序的状态，跟踪上一次的状态，通过比较前后两次状态差异更新真实DOM。</p>
</li>
</ul>
<h3 id="虚拟DOM的作用和虚拟DOM库"><a href="#虚拟DOM的作用和虚拟DOM库" class="headerlink" title="虚拟DOM的作用和虚拟DOM库"></a>虚拟DOM的作用和虚拟DOM库</h3><h4 id="虚拟DOM的作用"><a href="#虚拟DOM的作用" class="headerlink" title="虚拟DOM的作用"></a>虚拟DOM的作用</h4><ul>
<li>维护视图和状态的关系</li>
<li>复杂视图情况下提升渲染性能，视图比较简单或首次渲染时并不能提高性能</li>
<li>跨平台<ul>
<li>浏览器平台渲染DOM</li>
<li>服务端渲染SSR（Nuxt.js、Next.js）</li>
<li>原生应用（Weex/React Native）</li>
<li>小程序（mpvue/uni-app等）</li>
</ul>
</li>
</ul>
<h4 id="虚拟DOM库"><a href="#虚拟DOM库" class="headerlink" title="虚拟DOM库"></a>虚拟DOM库</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">Snabbdom</a><ul>
<li>Vue.js 2.x 内部使用的虚拟DOM就是改造的Snabbdom</li>
<li>大约200 SLOC（single line of code）</li>
<li>通过模块可扩展</li>
<li>源码使用TS开发</li>
<li>最快的Virtual DOM之一</li>
</ul>
</li>
</ul>
<h2 id="Snabbdom-基本使用"><a href="#Snabbdom-基本使用" class="headerlink" title="Snabbdom 基本使用"></a>Snabbdom 基本使用</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li><p>初始化项目目录、安装打包工具parcel</p>
<ul>
<li><p>输入如下命令行命令</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">md snabbdom<span class="token operator">-</span>demo
cd cd <span class="token punctuation">.</span>\snabbdom<span class="token operator">-</span>demo\
npm init <span class="token operator">-</span>y
npm install parcel<span class="token operator">-</span>bundler <span class="token operator">-</span><span class="token constant">D</span></code></pre></li>
</ul>
</li>
<li><p>配置script，打包或者启动项目</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"snabbdom-demo"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"parcel index.html --open"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"parcel build index.html"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"keywords"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"parcel-bundler"</span><span class="token operator">:</span> <span class="token string">"^1.12.5"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></li>
<li><p>初始化项目基本结构</p>
</li>
</ul>
<p><img src="/blogs/1d7d6fc9/5.jpg" loading="lazy"></p>
<h3 id="导入Snabbdom"><a href="#导入Snabbdom" class="headerlink" title="导入Snabbdom"></a>导入Snabbdom</h3><p><a target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">官方地址</a></p>
<ol>
<li>安装</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">yarn add snabbdom@<span class="token number">2.1</span><span class="token number">.0</span></code></pre>

<ol start="2">
<li>导入(此处路径与官网不同，官网的路径写法需要Webpack5.0支持)</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>

<h3 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h3><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// h函数用于创建虚拟DOM</span>
<span class="token comment">// 第一个参数：标签+选择器</span>
<span class="token comment">// 第二个参数：如果是字符串就是标签中的文本内容</span>
<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.cls'</span><span class="token punctuation">,</span> <span class="token string">'Hello World'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token comment">// patch函数的作用：对比两个vnode，把两个vnode的差异更新到页面中。（把虚拟dom转换为真实dom，并挂载到dom树上）</span>
<span class="token comment">// patch函数中，第一个参数：旧的VNode或DOM元素</span>
<span class="token comment">// 第二个参数：新的VNode</span>
<span class="token comment">// 返回新的VNode，即第二个参数，作为下一次更新的oldVNode（第一个参数）</span>
<span class="token keyword">let</span> oldVNode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span></code></pre>

<p><img src="/blogs/1d7d6fc9/6.jpg" loading="lazy"></p>
<p>添加如下代码：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.xxx'</span><span class="token punctuation">,</span> <span class="token string">'Hello Snabbdom'</span><span class="token punctuation">)</span>
<span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token comment">// 将新的vnode覆盖旧的</span></code></pre>

<p><img src="/blogs/1d7d6fc9/7.jpg" loading="lazy"></p>
<h3 id="案例2"><a href="#案例2" class="headerlink" title="案例2"></a>案例2</h3><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token string">'Hello Snabbdom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'这是一个p'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>    <span class="token comment">// 此处的oldVnode与 vnode是同一个东西</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 替换div中的内容</span>
    <span class="token comment">// vnode = h('div#container', [</span>
    <span class="token comment">//     h('h1', 'Hello XXC'),</span>
    <span class="token comment">//     h('p', 'Hello P')</span>
    <span class="token comment">// ])</span>
    <span class="token comment">// patch(oldVnode, vnode)</span>

    <span class="token comment">// 清除div中的内容</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 在h函数中传入一个'!'，表示生成一个空的节点</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>清除后的页面效果：</p>
<p><img src="/blogs/1d7d6fc9/8.jpg" loading="lazy"></p>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h3><blockquote>
<p>模块的作用</p>
</blockquote>
<ul>
<li>Snabbdom的核心库只能对VNode进行操作，并不能处理DOM元素得到属性/样式/事件等，可以通过注册Snabbdom默认提供的模块来实现</li>
<li>Snabbdom中的模块可以用来扩展Snabbdom的功能</li>
<li>Snabbdom中的模块的实现是通过注册全局的钩子函数来实现的</li>
</ul>
<blockquote>
<p>官方提供的模块</p>
</blockquote>
<p>attributes、props、dataset、class、style、eventlisteners</p>
<blockquote>
<p>模块使用步骤</p>
</blockquote>
<ul>
<li>导入需要的模块</li>
<li>init() 中注册模块</li>
<li>h() 函数的第二个参数处使用模块</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>

<span class="token comment">// 1.导入模块</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> styleModule <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/modules/style'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> eventListenersModule <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/modules/eventlisteners'</span>

<span class="token comment">// 2.注册模块</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    styleModule<span class="token punctuation">,</span>
    eventListenersModule
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 3.使用h() 函数的第二个参数传入模块中使用的数据（对象）</span>
<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        style<span class="token operator">:</span> <span class="token punctuation">&#123;</span> backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">'hello world'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        on<span class="token operator">:</span> <span class="token punctuation">&#123;</span> click<span class="token operator">:</span> eventHandler <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">'Hello P'</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">eventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'别点我，疼'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span></code></pre>

<h2 id="Snabbdom源码解析"><a href="#Snabbdom源码解析" class="headerlink" title="Snabbdom源码解析"></a>Snabbdom源码解析</h2><blockquote>
<p>Vue中的虚拟dom是通过改造Snabbdom实现的，看完Snabbdom源码后便可掌握Vue中虚拟dom的实现原理。</p>
</blockquote>
<h3 id="如何学习源码"><a href="#如何学习源码" class="headerlink" title="如何学习源码"></a>如何学习源码</h3><ul>
<li>宏观了解</li>
<li>带着目标看源码</li>
<li>看源码的过程要不求甚解</li>
<li>调试</li>
<li>参考资料</li>
</ul>
<blockquote>
<p>看源码时需要的几个快捷键</p>
</blockquote>
<p><img src="/blogs/1d7d6fc9/13.jpg" loading="lazy"></p>
<h3 id="Snabbdom的核心"><a href="#Snabbdom的核心" class="headerlink" title="Snabbdom的核心"></a>Snabbdom的核心</h3><ul>
<li>init() 设置模块，创建patch() 函数</li>
<li>使用h() 函数创建JavaScript 对象(VNode) 来描述真实DOM</li>
<li>patch()比较新旧两个Vnode，如果第一个参数是真实DOM会将其转化为Vnode</li>
<li>把变化的内容更新到真实DOM树</li>
</ul>
<h4 id="h函数介绍"><a href="#h函数介绍" class="headerlink" title="h函数介绍"></a>h函数介绍</h4><ul>
<li><p>作用：创建VNode对象</p>
</li>
<li><p>Vue中的h函数</p>
<p><img src="/blogs/1d7d6fc9/9.jpg" loading="lazy"></p>
</li>
<li><p>h函数最早见于hyperscript，使用JavaScript创建超文本</p>
</li>
</ul>
<blockquote>
<p>函数重载</p>
</blockquote>
<ul>
<li>参数个数或参数类型不同的函数。</li>
<li>JavaScript中没有重载的概念。</li>
<li>TypeScript中有重载，不过重载的实现还是通过代码调整参数。</li>
</ul>
<blockquote>
<p>函数重载-参数个数</p>
</blockquote>
<p><img src="/blogs/1d7d6fc9/10.jpg" loading="lazy"></p>
<blockquote>
<p>函数重载-参数类型</p>
</blockquote>
<p><img src="/blogs/1d7d6fc9/12.jpg" loading="lazy"></p>
<blockquote>
<p>h函数解析：</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span>
  <span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> VNodeChildren</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> any<span class="token punctuation">,</span> b<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> c<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> data<span class="token operator">:</span> VNodeData <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> children<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token keyword">let</span> text<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i<span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token comment">// 处理参数，实现重载的机制</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 处理三个参数的情况</span>
    <span class="token comment">// set data children/text</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      data <span class="token operator">=</span> b<span class="token punctuation">;</span>		<span class="token comment">// 此处的data是一些模块需要的属性</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果是数组，说明是给当前节点设置子元素</span>
      children <span class="token operator">=</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果 c 是字符串或者数字，将其转为字符串</span>
      text <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 如果c 是VNode，转为数组，存储到children中</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      children <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      text <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      data <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 正常情况下，children中应该都是vnode对象，如果是字符串或数字，说明用户没有调用h函数，此时会调用vnode函数，将字符串或数字转为vnode</span>
        children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span>
          <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          <span class="token keyword">undefined</span><span class="token punctuation">,</span>
          children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token keyword">undefined</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    sel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"s"</span> <span class="token operator">&amp;&amp;</span>
    sel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"v"</span> <span class="token operator">&amp;&amp;</span>
    sel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"g"</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>sel<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"."</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"#"</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果是 svg，添加命名空间</span>
    <span class="token function">addNS</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 返回vnode</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h4 id="VNode函数介绍"><a href="#VNode函数介绍" class="headerlink" title="VNode函数介绍"></a>VNode函数介绍</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Hooks <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./hooks"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> AttachData <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./helpers/attachto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> VNodeStyle <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/style"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> On <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/eventlisteners"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Attrs <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/attributes"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Classes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/class"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Props <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/props"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Dataset <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./modules/dataset"</span><span class="token punctuation">;</span>

<span class="token comment">// Key为字符串或数值或Symbol，用于唯一标识当前的VNode对象</span>
<span class="token keyword">export</span> type Key <span class="token operator">=</span> string <span class="token operator">|</span> number <span class="token operator">|</span> symbol<span class="token punctuation">;</span>

<span class="token comment">// VNode接口，用于标识最终创建的VNode对象具有哪些属性</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">&#123;</span>
  sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>    <span class="token comment">// 选择器</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>  <span class="token comment">// 模块中的所需要数据</span>
  children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>    <span class="token comment">// children：子节点，与text互斥</span>
  elm<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>  <span class="token comment">// VNode转换后的dom元素</span>
  text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>   <span class="token comment">// text：文本节点中的文本内容，与children互斥</span>
  key<span class="token operator">:</span> Key <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>   <span class="token comment">// 唯一标识一个节点</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// VNodeData接口，用于约束VNode中data属性。</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNodeData</span> <span class="token punctuation">&#123;</span>
  props<span class="token operator">?</span><span class="token operator">:</span> Props<span class="token punctuation">;</span>
  attrs<span class="token operator">?</span><span class="token operator">:</span> Attrs<span class="token punctuation">;</span>
  <span class="token keyword">class</span><span class="token operator">?</span><span class="token operator">:</span> Classes<span class="token punctuation">;</span>
  style<span class="token operator">?</span><span class="token operator">:</span> VNodeStyle<span class="token punctuation">;</span>
  dataset<span class="token operator">?</span><span class="token operator">:</span> Dataset<span class="token punctuation">;</span>
  on<span class="token operator">?</span><span class="token operator">:</span> On<span class="token punctuation">;</span>
  attachData<span class="token operator">?</span><span class="token operator">:</span> AttachData<span class="token punctuation">;</span>
  hook<span class="token operator">?</span><span class="token operator">:</span> Hooks<span class="token punctuation">;</span>
  key<span class="token operator">?</span><span class="token operator">:</span> Key<span class="token punctuation">;</span>
  ns<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">// for SVGs</span>
  fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> VNode<span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  args<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// for thunks</span>
  is<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">// for custom elements v1</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">;</span> <span class="token comment">// for any other 3rd party module</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span>
  <span class="token parameter">sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  elm<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">undefined</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>key<span class="token punctuation">;</span>  <span class="token comment">// key是通过data来赋值的</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> key <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token comment">// 返回一个普通的对象，具备VNode接口定义的6个属性</span>
<span class="token punctuation">&#125;</span>
</code></pre>

<h4 id="patch整体过程分析"><a href="#patch整体过程分析" class="headerlink" title="patch整体过程分析"></a>patch整体过程分析</h4><ul>
<li>patch(oldVnode,newVnode)</li>
<li>把新节点中变化的内容渲染到真实DOM，最后返回新节点作为下一次处理的旧节点</li>
<li>对比新旧VNode是否具有相同节点(节点的key和sel相同)</li>
<li>如果不是相同节点，删除之前的内容，重新渲染</li>
<li>如果是相同节点，再判断新的VNode是否有text，如果有并且和oldVnode的text不同，直接更新文本内容</li>
<li>如果新的VNode有children，判断子节点是否有变化（diff算法中最复杂的部分）</li>
</ul>
<h4 id="init函数介绍"><a href="#init函数介绍" class="headerlink" title="init函数介绍"></a>init函数介绍</h4><blockquote>
<p>要调用init函数，才能返回得到一个patch函数</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">...</span><span class="token operator">...</span>
<span class="token comment">// init函数的第二个参数用来把vnode对象转换为其它平台下的元素api，没有传递时默认转为dom下的api元素（虚拟DOM实现跨平台）</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">modules<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Partial<span class="token operator">&lt;</span>Module<span class="token operator">>></span><span class="token punctuation">,</span> domApi<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">DOMAPI</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cbs<span class="token operator">:</span> ModuleHooks <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 存储模块中的钩子函数，将来会在合适的时机执行</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    destroy<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pre<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
  <span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi<span class="token punctuation">;</span>   <span class="token comment">// api默认将dom转为浏览器环境下的api对象，此api具有一些操作dom的方法</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> hook <span class="token keyword">of</span> hooks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 把模块中的钩子函数push到cbs的数组中。</span>
      <span class="token keyword">const</span> currentHook <span class="token operator">=</span> module<span class="token punctuation">[</span>hook<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// cbs ---->  &#123;create:[fn1,fn2] , update:[fn1,fn2] , .....&#125;</span>
        <span class="token punctuation">(</span>cbs<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
    
  <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token comment">// 返回patch函数，使得patch函数调用时传递的参数变少(init函数中加modules和domApi做了缓存，达到高阶函数的效果)</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
   <span class="token operator">...</span><span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h4 id="patch函数介绍"><a href="#patch函数介绍" class="headerlink" title="patch函数介绍"></a>patch函数介绍</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span><span class="token parameter">vnode1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode2<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">&#123;</span>
  <span class="token comment">// 判断cnode的key、data中的is，sel是否相同</span>
  <span class="token keyword">const</span> isSameKey <span class="token operator">=</span> vnode1<span class="token punctuation">.</span>key <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isSameIs <span class="token operator">=</span> vnode1<span class="token punctuation">.</span>data<span class="token operator">?.</span>is <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>data<span class="token operator">?.</span>is<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isSameSel <span class="token operator">=</span> vnode1<span class="token punctuation">.</span>sel <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>

  <span class="token keyword">return</span> isSameSel <span class="token operator">&amp;&amp;</span> isSameKey <span class="token operator">&amp;&amp;</span> isSameIs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">isVnode</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> vnode is VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>   <span class="token comment">// 如果vnode有sel属性，就说起其为vnode对象</span>
<span class="token punctuation">&#125;</span> 
    
<span class="token keyword">function</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span><span class="token parameter">elm<span class="token operator">:</span> Element</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> elm<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">"#"</span> <span class="token operator">+</span> elm<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">// 获取元素id，若存在在其前面加'#'，否则返回空字符串</span>

    <span class="token comment">// elm.className doesn't return a string when elm is an SVG element inside a shadowRoot.</span>
    <span class="token comment">// https://stackoverflow.com/questions/29454340/detecting-classname-of-svganimatedstring</span>
    <span class="token keyword">const</span> classes <span class="token operator">=</span> elm<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> c <span class="token operator">=</span> classes <span class="token operator">?</span> <span class="token string">"."</span> <span class="token operator">+</span> classes<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token comment">// 获取类样式，转换为选择器形式</span>
    <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>     <span class="token comment">// 调用vnode函数，创建vnode对象</span>
        api<span class="token punctuation">.</span><span class="token function">tagName</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> id <span class="token operator">+</span> c<span class="token punctuation">,</span>    <span class="token comment">// 将id与类样式拼接起来，作为vnode对象的sel</span>
        <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">// data</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// children</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>  <span class="token comment">// text</span>
        elm   <span class="token comment">// dom元素</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 返回patch函数，使得patch函数调用时传递的参数变少(init函数中加modules和domApi做了缓存，达到高阶函数的效果)</span>
<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>   <span class="token comment">// patch函数第一个参数既可以是VNode对象，又可以是普通的DOM对象</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> number<span class="token punctuation">,</span> elm<span class="token operator">:</span> Node<span class="token punctuation">,</span> parent<span class="token operator">:</span> Node<span class="token punctuation">;</span>
    <span class="token keyword">const</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 存储新插入结点的队列，目的是为了触发节点的insert钩子函数。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 触发cbs中所有pre钩子函数，并依次执行。pre钩子函数是处理vnode的钩子函数中的第一个钩子函数</span>

    <span class="token comment">// 第一次创建 Vnode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 通过isVnode判断第一个参数是否为Vnode对象</span>
      oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 通过emptyNodeAt函数将dom对象转换为Vnode对象</span>
    <span class="token punctuation">&#125;</span>
	
    <span class="token comment">// 相同的 vnode (key 和 sel 都相等)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 判断新旧vnode是否是相同节点，如果相同，进行差异寻找，而不用创建新节点，提高了效率</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 找到两个vnode节点的差异，并更新到dom上</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果节点不同，会创建新的vnode对应的dom元素，并把新创建的dom元素放到dom树上，并把老节点对应的dom元素移出（即删除重建）</span>
      elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">;</span>    <span class="token comment">// ! 表示当前元素一定是有值的，后续可以直接使用（TS语法）</span>
      parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span> <span class="token keyword">as</span> Node<span class="token punctuation">;</span>   <span class="token comment">// 获取父元素</span>

      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 创建vnode节点对应的dom元素，并且把insertedVnodeQueue作为参数传入，同时函数内部会触发一些钩子函数。此处的vnode中的elm为undefined，createElm创建成功后其才有值</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断parent是否有值，若有则把新的vnode对象对应的dom元素挂载到dom树上。</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 此处的nextSibling(elm)用于查看老vnode中下一个兄弟节点。并将新节点插入到其之前（及老节点之后）</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 将老节点对应的dom元素移除</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insertedVnodeQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 触发新的vnode阶段对应的insert钩子函数</span>
      insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token operator">!</span><span class="token punctuation">.</span>insert<span class="token operator">!</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// insertedVnodeQueue中的元素是在createElm中添加的。‘！’用来推断前面的属性是否有指，有值继续，没值停止（代替了if语句）</span>
      <span class="token comment">// insert钩子函数是从data中获取的（说明是用户传递过来的）</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 触发模块中的post钩子函数</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>   <span class="token comment">// 返回新的vnode节点</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<h4 id="createElm-函数介绍"><a href="#createElm-函数介绍" class="headerlink" title="createElm 函数介绍"></a>createElm 函数介绍</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> emptyNode <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">function</span> <span class="token function">createElm</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> any<span class="token punctuation">;</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 执行用户设置的init钩子函数</span>
    <span class="token comment">// 此处的data是h函数执行时的第二个对象参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> init <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>init<span class="token punctuation">;</span>  <span class="token comment">// hook.init是用户传递的。  ? ：判断hook是否有值，有值的返回init，没值返回undefined。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断init是否有定义</span>
        <span class="token function">init</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 调用init函数，作用：在创建真实dom之前，让用户可以对vnode进行修改。比如更改样式等属性</span>
        data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>  <span class="token comment">// 将更改后的vnode(被init修改的)重新赋值给data。</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">const</span> sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel<span class="token punctuation">;</span>
    <span class="token comment">// 把 vnode 转换成真实 DOM 对象（没有渲染到页面）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">"!"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果sel的值为！，会创建一个注释节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断传过来的vnode.text是否为undefined，是的话转成空字符串</span>
        vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">// 此处的text为注释节点中的文本内容</span>
      <span class="token punctuation">&#125;</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// createComment用于创建注释节点</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 如果选择器不为空，解析选择器</span>
      <span class="token keyword">const</span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 获取# 和 id的索引</span>
      <span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> tag <span class="token operator">=</span>
        hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>
          <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> sel<span class="token punctuation">;</span>    <span class="token comment">// 从sel中解析出标签名</span>

      <span class="token comment">// 创建dom元素</span>
      <span class="token keyword">const</span> elm <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span>
        <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// ns为命名空间，根据是否有命名空间来判断用那个创建方法</span>
          <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
          <span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 为dom元素添加id和类样式</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIdx <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 触发模块中的create钩子函数</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果children是数组的话，遍历所有子节点，并递归调用createElm（此处如果有children，则children一定是一个数组，因为h函数中实现了相关逻辑）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果children不是数组，判断text是否为原始值，及string和number。</span>
        api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 当text时原始值时，才将其放到添加为子节点</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token punctuation">;</span>      <span class="token comment">// 获取用户传入的hook函数（hook函数个人理解是一些模块中定义的东西）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hook<span class="token punctuation">.</span>create<span class="token operator">?.</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 判断hook是否有create,如果有的话就触发</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断hook中是否有insert，有的话将vnode加入到inserted队列中</span>
          insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 如果选择器为空，创建文本节点</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 返回新创建的 DOM</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span></code></pre>

<h4 id="用户如何定义hook函数"><a href="#用户如何定义hook函数" class="headerlink" title="用户如何定义hook函数"></a>用户如何定义hook函数</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// h函数用于创建虚拟DOM</span>
<span class="token comment">// 第一个参数：标签+选择器</span>
<span class="token comment">// 第二个参数：如果是字符串就是标签中的文本内容</span>
<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.cls'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    hook<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">emptyNode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// create是dom元素创建完后执行的</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'Hello World'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token comment">// patch函数的作用：对比两个vnode，把两个vnode的差异更新到页面中。（把虚拟dom转换为真实dom，并挂载到dom树上）</span>
<span class="token comment">// patch函数中，第一个参数：旧的VNode或DOM元素</span>
<span class="token comment">// 第二个参数：新的VNode</span>
<span class="token comment">// 返回新的VNode，即第二个参数，作为下一次更新的oldVNode（第一个参数）</span>
<span class="token keyword">let</span> oldVNode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>

vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div#container.xxx'</span><span class="token punctuation">,</span> <span class="token string">'Hello Snabbdom'</span><span class="token punctuation">)</span>
<span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>  <span class="token comment">// 将新的vnode覆盖旧的</span></code></pre>

<h4 id="removeVnodes-和-addVnodes"><a href="#removeVnodes-和-addVnodes" class="headerlink" title="removeVnodes 和 addVnodes"></a>removeVnodes 和 addVnodes</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript">  <span class="token keyword">function</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span><span class="token parameter">childElm<span class="token operator">:</span> Node<span class="token punctuation">,</span> listeners<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rmCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>listeners <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 此处的listeners在cbs中的所有remove函数执行完后等于1，当最后调用一次rm()函数后，才可进入if判断。</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>childElm<span class="token punctuation">)</span> <span class="token keyword">as</span> Node<span class="token punctuation">;</span>
        api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> childElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">addVnodes</span><span class="token punctuation">(</span>
    parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>    <span class="token comment">// 父元素</span>
    before<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token comment">// 插入到其前面的元素</span>
    vnodes<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 要插入的元素</span>
    startIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>   <span class="token comment">// 起始</span>
    endIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>   <span class="token comment">// 结束</span>
    insertedVnodeQueue<span class="token operator">:</span> VNodeQueue    <span class="token comment">// 存储具有insert钩子函数的vnode节点队列</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      data<span class="token operator">?.</span>hook<span class="token operator">?.</span>destroy<span class="token operator">?.</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 判断用户是否传入destory钩子函数，若传入，则调用</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 调用cbs中的destroy函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 若存在子节点，则递归调用invokeDestroyHook</span>
          <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> child <span class="token operator">!==</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">removeVnodes</span><span class="token punctuation">(</span>    <span class="token comment">// 参数：父元素，要删除元素，起始位置，结束位置</span>
    parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
    vnodes<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    startIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>
    endIdx<span class="token operator">:</span> number
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 通过开始位置与结束位置遍历vnodes数组</span>
      <span class="token keyword">let</span> listeners<span class="token operator">:</span> number<span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token function-variable function">rm</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 如果vnode存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>sel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果vnode是元素节点</span>
          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 触发vnode中destroy钩子函数及cbs中的destroy钩子函数</span>
          listeners <span class="token operator">=</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// 获取cbs中remove钩子函数的个数并加1，listeners用于避免重复删除dom元素，此处+1是保证在remove函数全部执行完后再调用rm函数</span>
          <span class="token comment">// rm函数的删除节点操作要么在removeHook(ch,rm)中调用，要么在rm()中调用，因为listeners始终比remove.length大1，当所有remove函数执行完后，listeners为1。所以最终通过前面两个函数来删除节点</span>
          rm <span class="token operator">=</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// createRmCb 为高阶函数，内部返回真正删除dom元素的函数。</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 触发cbs中所有的remove构造函数，remove中会调用rm来删除dom元素</span>
          <span class="token keyword">const</span> removeHook <span class="token operator">=</span> ch<span class="token operator">?.</span>data<span class="token operator">?.</span>hook<span class="token operator">?.</span>remove<span class="token punctuation">;</span>    <span class="token comment">// 判断用户是否传入remove钩子函数</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>removeHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">removeHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 如果传入，则需要手动调用rm删除</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 没传入则直接调用rm。</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 如果vnode是文本节点</span>
          api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 直接调用removeChild删除文本节点</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span></code></pre>

<h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><blockquote>
<p>作用，对比两个新旧vnode节点，找到它们的差异后更新到真实dom上</p>
</blockquote>
<p><img src="/blogs/1d7d6fc9/14.jpg" loading="lazy"></p>
<ul>
<li>此处第3、5步要先移除老节点的children，以便触发remove钩子函数（里面可能有一些动画效果等），而不能直接将新节点的text属性替换掉老节点的children元素。</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span>
  <span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 第一个过程：触发 prepatch 和 uodate 钩子函数</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">?.</span>hook<span class="token punctuation">;</span>    <span class="token comment">// 如果用户传入了prepatch钩子函数，则立即执行。</span>
  hook<span class="token operator">?.</span>prepatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
  <span class="token keyword">const</span> elm <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>    <span class="token comment">// 将旧节点的elm属性赋值给新节点</span>
  
  <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 获取新旧节点的子节点</span>
  <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">// 比较新旧节点是否是相同节点，若是，则直接返回。</span>
      
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 如果不是相同节点，且新节点的data有值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>   <span class="token comment">// 则执行cbs中所有update钩子函数</span>
    cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>update<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 执行用户传入的update钩子函数，后执行用户传入的update的原因是因为用户传入的update数据可以覆盖模块中的update数据</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第二个过程：真正对比新旧 vnode 差异的地方</span>
  <span class="token comment">/*
  	新无text有children，旧无text有children ->  调用 updateChildren 
  	新无text有children，旧有text无children ->  将旧的 text 清空，调用 addVnodes，将新的vnode 的 children 传入
  	新无text有children，旧无text无children ->  直接将新的 VNode 的 children 传入（与上一种情况合并）
  	
  	新无text无children，旧无text有children ->  调用 removeVnodes 将 旧的Vnode的子节点清除
  	新无text无children，旧有text无children ->  将旧的 text 清空。
  	新无text无children，旧有text无children ->  忽略，不做任何处理
  	
  	新有text无children，旧无text有children ->  将老节点用 removeVnodes 清空，使用 setTextContent 将新的 text 插入
  	新有text无children，旧有text无children ->  两者若不相同，则直接用新的覆盖旧的
  	新有text无children，旧无text无children ->  使用 setTextContent 将新的text插入
  */</span>
  <span class="token comment">// 新节点不存在 text 的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断新节点是否具有text属性，没有的话继续比较子节点（text与children互斥）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果新旧节点都有子节点且不同，则调用updateChildren（对比新旧节点中所有的子节点并更新dom）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 
      
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 如果新节点有子节点（老节点没有），且老节点有text属性，将text清空，调用addVnodes将新节点的子节点添加到elm中。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 将旧节点的 text 清空</span>
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 添加 children</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 下面两个判断是代表新节点什么都没有，判断旧节点 是否有 子节点 或者有 text(不必判断旧节点什么都没有的情况)</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 如果老节点有子节点（新节点没有），调用removeVnodes将老节点的子元素从dom树移出</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 
    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 老节点有text属性，清空老节点</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> 
      
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 此时新节点有text属性，再判断如果新旧节点的text不相等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 如果老节点有子节点</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 去除子节点</span>
    <span class="token punctuation">&#125;</span>
    api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 将新节点的text渲染到页面上（此处还是使用之前的dom元素，仅仅是更新了元素内容）</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 第三个过程：触发postpatch钩子函数</span>
  hook<span class="token operator">?.</span>postpatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="updateChildren整体过程"><a href="#updateChildren整体过程" class="headerlink" title="updateChildren整体过程"></a>updateChildren整体过程</h4><blockquote>
<p>Diff算法</p>
<p>渲染真实dom的开销很大，dom操作会引起浏览器的重排和重绘。虚拟dom中diff的核心是当数据变化后不直接操作dom，而是用js对象来描述真实dom，当数据变化后会先比较js对象是否发生变化，找到所有变化的位置，并只去最小化的更新变化位置，从而提高性能。</p>
</blockquote>
<ul>
<li><p>虚拟DOM中的Diff算法</p>
<ul>
<li><p>查找两颗树每一个节点的差异</p>
<p><img src="/blogs/1d7d6fc9/15.jpg" loading="lazy"></p>
<p>此种节点比较方式，当有n个节点时，需要比较n^2次，最后还要循环遍历重新渲染。时间复杂度是O(n)^3</p>
</li>
</ul>
</li>
<li><p>Snabbdom根据DOM的特点对传统的diff算法做了优化</p>
<ul>
<li><p>DOM操作时很少会跨级别操作节点。</p>
</li>
<li><p>只比较同级别的节点，如果同级别不相同，直接删除，重新创建。</p>
</li>
<li><p>同级别的节点只需要比较一次，从而达到减少节点比较次数的目的。</p>
<p><img src="/blogs/1d7d6fc9/16.jpg" loading="lazy"></p>
<p>当有n个节点时，只需要循环n次，循环时同时把找到的节点之间的差异更新到真实dom中。时间复杂度O(n)。</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>执行过程</p>
</blockquote>
<ul>
<li>在对开始和结束节点比较的时候，总共有四种情况<ul>
<li>oldStartVnode/newStartVnode (旧开始节点 / 新开始节点)</li>
<li>oldEndVnode / newEndVnode (旧结束节点 / 新结束节点)</li>
<li>oldStartVnode / newEndVnode (旧开始节点 / 新结束节点)</li>
<li>oldEndVnode / newStartVnode (旧结束节点 / 新开始节点)</li>
</ul>
</li>
</ul>
<img src="/blogs/1d7d6fc9/17.jpg" style="zoom:67%;" loading="lazy">

<ul>
<li><p>如果新旧开始节点是 sameVnode (key和sel相同)</p>
<ul>
<li>调用 patchVnode() 对比和更新节点</li>
<li>把旧开始和新开始索引往后移动 oldStartIdx++ / oldEndIdx++ </li>
</ul>
</li>
</ul>
<p><img src="/blogs/1d7d6fc9/18.jpg" loading="lazy"></p>
<div class="success">

<blockquote>
<p>先判断旧开始节点与新开始节点1是否是相同节点，如果是相同节点的话调用patchVnode比较两个节点内部的差异，然后更新到真实dom，比较完成后移动索引到第二个位置，继续比较第二个节点之间的差异。<br>如果开始节点不是sameVnode，则从后往前进行比较，比较3是否是someVnode，是的话调用patchVnode进行差异比较，更新到真实dom，移动索引。<br>如果是sameVnode的话，会重用旧节点的dom元素。在patchVnode中会比较两个节点的差异，然后把差异更新到重用的dom元素上，而当前的dom是不需要重新创建的。如果文本内容或子元素也都相同的话，是不会进行dom操作的。从而提高性能。</p>
</blockquote>
</div>

<ul>
<li>比较旧开始节点与新结束节点<ul>
<li>如果是相同节点，调用patchVnode()对比和更新节点</li>
<li>把oldStartVnode对应的DOM元素，移动到右边，更新索引，将旧开始节点的索引移动到2，新结束节点的索引移动到6</li>
</ul>
</li>
</ul>
<p><img src="/blogs/1d7d6fc9/19.jpg" loading="lazy"></p>
<ul>
<li><p>比较旧结束节点与新开始节点</p>
<ul>
<li>如果是相同节点，调用patchVnode() 对比和更新节点</li>
<li>把oldEndVnode 对应的DOM元素，移动到左边，更新索引</li>
</ul>
<p><img src="/blogs/1d7d6fc9/20.jpg" loading="lazy"></p>
</li>
<li><p>非上述四种情况</p>
<ul>
<li><p>遍历新的开始节点，在旧的节点数组中查找是否具有相同key值的节点，若没找到，说明此时的开始节点是新的节点，就需要创建新的dom元素并将其插入到最前面的位置</p>
</li>
<li><p>如果找到具有相同key值的节点，继续判断sel是否相同，如果不同，就需要创建新的dom元素并将其插入到最前面的位置</p>
</li>
<li><p>如果key和sel都相同，将elmToMove赋值给这个旧节点，并通过patchVnode比较两个节点的差异并更新，并将elmToMove移动到最前面。</p>
</li>
</ul>
</li>
</ul>
<p><img src="/blogs/1d7d6fc9/21.jpg" loading="lazy"></p>
<ul>
<li><p>循环结束</p>
<ul>
<li><p>当老节点的所有子节点先遍历完（oldStartIdx &gt; oldEndIdx）</p>
<ul>
<li><p>说明新节点有剩余，把剩余节点批量插入到右边（调用addVnodes）</p>
<p><img src="/blogs/1d7d6fc9/22.jpg" loading="lazy"></p>
</li>
</ul>
</li>
<li><p>当新节点的数组先遍历完（newStartIdx&gt;newEndIdx）</p>
<ul>
<li><p>说明老节点有剩余，把剩余节点批量删除</p>
<p><img src="/blogs/1d7d6fc9/23.jpg" loading="lazy"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="updateChildren函数介绍"><a href="#updateChildren函数介绍" class="headerlink" title="updateChildren函数介绍"></a>updateChildren函数介绍</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>
   parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>    <span class="token comment">// 父元素，用来添加新元素或删除旧元素</span>
   oldCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 旧节点子节点</span>
   newCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 新节点子节点</span>
   insertedVnodeQueue<span class="token operator">:</span> VNodeQueue
 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">// 旧开始节点索引</span>
   <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">// 新开始节点索引</span>
   <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 旧结束节点索引</span>
   <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// 旧开始节点</span>
   <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 旧结束节点</span>
   <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 新结束节点索引</span>
   <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 新开始节点</span>
   <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 新结束节点</span>
   <span class="token keyword">let</span> oldKeyToIdx<span class="token operator">:</span> KeyToIndexMap <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> idxInOld<span class="token operator">:</span> number<span class="token punctuation">;</span>
   <span class="token keyword">let</span> elmToMove<span class="token operator">:</span> VNode<span class="token punctuation">;</span>
   <span class="token keyword">let</span> before<span class="token operator">:</span> any<span class="token punctuation">;</span>

   <span class="token comment">// 同级别节点比较</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 循环条件：旧节点开始索引小于旧节点结束索引，新节点开始索引小于新节点结束索引</span>
     <span class="token comment">// 查看新旧开始、结束节点是否为null，若为null则更新索引，重新赋值</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Vnode might have been moved left</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token comment">// 比较开始和结束的4种情况</span>
     <span class="token punctuation">&#125;</span> 
       
       
     <span class="token comment">// 开始与开始做对比</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 比较新旧开始节点是否相同</span>
       <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 若相同，则重用旧开始节点的dom元素，比较二者差异，更新到真实dom上</span>
       oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// 索引指向下一个节点，并将下一个节点作为新旧开始节点</span>
       newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// 在下一次循环时，比较新旧的开始节点的下一个节点是否是相同节点，若不是，会比较旧的结束节点与新的结束节点是否是相同节点</span>
     <span class="token punctuation">&#125;</span> 
     <span class="token comment">// 结束与结束做对比</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 如果新旧结束节点是相同节点，则重用旧结束节点的dom元素，比较二者差异，更新到真实dom上</span>
       <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
       oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 索引指向上一个节点，并将上一个节点作为新旧结束节点</span>
       newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> 
     <span class="token comment">// 开始与结束做对比</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 如果新旧开始和结束节点不相同，则比较旧的开始节点与新的结束节点是否相同</span>
       <span class="token comment">// Vnode moved right</span>
       <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 如果相同，则重用旧开始节点的dom元素，比较二者差异，更新到真实dom上</span>
       api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>   <span class="token comment">// 将旧开始节点对应的dom元素移动到旧的结束节点对应的dom元素之后（使得与新节点的位置对应）</span>
         parentElm<span class="token punctuation">,</span>
         oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span>
         api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
       oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 移动对应的索引</span>
       newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> 
     <span class="token comment">// 结束与开始做对比  </span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 不满足以上三种情况下，比较旧的结束的节点与新的开始节点是否相同</span>
       <span class="token comment">// Vnode moved left</span>
       <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 执行patchVnode</span>
       api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将旧的结束节点对应的dom元素移动到旧的开始节点对应的dom元素之前</span>
       oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 移动对应的索引</span>
       newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> 
       
  
     <span class="token comment">// 以上四个都未命中</span>
     <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// 不满足以上4种情况，遍历新节点，通过新节点的key，来老节点数组找相同的key的节点，并移动到对应的位置</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// oldKeyToIdx :&#123;老节点的key,老节点的索引&#125;，根据key来找索引</span>
         oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// createKeyToOldIdx有三个参数：老节点数组，老节点开始索引、老节点结束索引</span>
       <span class="token punctuation">&#125;</span>
       idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> string<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 用新节点的key作为参数来老节点map对象中索取老节点索引</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 当新节点在老节点中不存在时，及没对应上</span>
         api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>   <span class="token comment">// 如果是undefined，将新的开始节点转换为真实dom，并插入到老的开始节点之前</span>
           parentElm<span class="token punctuation">,</span>
           <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span>
           oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
         <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
         elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// 如果在老节点数组中找到了相同key的节点，再比较 sel 是否相等</span>
      
         <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 比较新节点的sel与老节点的sel是否相同。若不相同说明这个节点被修改过</span>
           api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>   <span class="token comment">// 创建新的dom元素，并插入到老的开始节点之前</span>
             parentElm<span class="token punctuation">,</span>
             <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span>
             oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
           <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span> 
         <span class="token comment">// sel 相等、key相等    </span>
         <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果老节点和新节点相同，则使用patchVnode进行新旧节点比较，并将新节点更新到dom元素中</span>
           <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
           oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>   <span class="token comment">// 将老节点数组对应位置的老节点设置为null</span>
           api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> elmToMove<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将老节点对应的dom元素移动到老的开始节点之前（使得下次比较不包含这个节点）</span>
         <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
       newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 让新的开始节点索引++，获取下一个节点作为新的开始节点</span>
     <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token comment">// 循环结束的收尾工作</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 判断新旧节点的开始索引小于结束索引，确保至少有一个数组没有遍历完</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">></span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 当老节点数组先遍历完，新节点数组中有剩余</span>
       before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">;</span>    <span class="token comment">// 插入到哪个节点前</span>
       <span class="token function">addVnodes</span><span class="token punctuation">(</span>
         parentElm<span class="token punctuation">,</span>
         before<span class="token punctuation">,</span>
         newCh<span class="token punctuation">,</span>
         newStartIdx<span class="token punctuation">,</span>
         newEndIdx<span class="token punctuation">,</span>
         insertedVnodeQueue
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 当新节点数组先遍历完，老节点数组中有剩余</span>
       <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 使用removeVnodes批量移除元素</span>
     <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span></code></pre>

<h4 id="Key-的意义"><a href="#Key-的意义" class="headerlink" title="Key 的意义"></a>Key 的意义</h4><blockquote>
<p>key用于diff算法中比较新旧Vnode，当不设置key的时候，某些情况下会认为新旧Vnode相同(当sel相同的)，最大程度的重用dom。</p>
<p>而若设置了key，当key相同时，会移动dom元素，当key不同时，创建新dom元素。</p>
<p>需要给具有相同父元素的子元素设置唯一的key，否则会造成渲染错误。</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/h'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> attributesModule <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/modules/attributes'</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> eventListenersModule <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/modules/eventlisteners'</span>

<span class="token keyword">let</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attributesModule<span class="token punctuation">,</span> eventListenersModule<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token comment">// data为要渲染的数据，函数返回新的vnode</span>
  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 不设置 key</span>
    <span class="token comment">// arr.push(h('li', [h('input', &#123; attrs: &#123; type: 'checkbox' &#125; &#125;), h('span', item)]))</span>
    <span class="token comment">// 设置key</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> attrs<span class="token operator">:</span> <span class="token punctuation">&#123;</span> type<span class="token operator">:</span> <span class="token string">'checkbox'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    on<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        data<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        vnode <span class="token operator">=</span> <span class="token function">view</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'按钮'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> vnode
<span class="token punctuation">&#125;</span>


<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token comment">// 首次渲染</span>
oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token function">view</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<h4 id="key-的作用"><a href="#key-的作用" class="headerlink" title="key 的作用"></a>key 的作用</h4><p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#key">https://cn.vuejs.org/v2/api/#key</a></p>
<ul>
<li>有相同父元素的子元素必须有<strong>独特的 key</strong>。重复的 key 会造成渲染错误。</li>
</ul>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item in items<span class="token punctuation">"</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item.id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></code></pre>

<ul>
<li>它也可以用于强制替换元素/组件而不是重复使用它（比如某些动画要替换才能生效）</li>
</ul>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transition</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; text &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transition</span><span class="token punctuation">></span></span></code></pre>

<h4 id="Diff-过程"><a href="#Diff-过程" class="headerlink" title="Diff 过程"></a>Diff 过程</h4><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onClick<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item in arr<span class="token punctuation">"</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&#123;&#123; item &#125;&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>../node_modules/vue/dist/vue.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      arr<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token function">onClick</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 不是响应式的</span>
        <span class="token comment">// this.arr[0] = 0</span>
        <span class="token comment">// this.arr.splice(0, 1, 0)</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>

<p>旧节点 —&gt; [vnode, vnode, vnode]</p>
<p>新节点 —&gt; [vnode, vnode, vnode]</p>
<ul>
<li>四种情况演示：<ul>
<li>更改第一个元素的值，设置 key 和不设置 key</li>
<li>翻转数组，设置 key 和不设置 key</li>
</ul>
</li>
<li>更改第一个元素的值，不设置 key<ul>
<li>123</li>
<li>023</li>
</ul>
</li>
</ul>
<pre class="language-none"><code class="language-none">updateChildren() 的时候比较新旧 VNode 数组中的第一个 VNode   (li)，此时是 sameVnode()
调用 patchVnode() 比较 VNode   (li)，都有子节点（文本节点）继续调用 updateChildren()
文本节点也都是 sameVnode() 调用 patchVnode()，此时有 text 属性，直接更新 li 的 text
继续比较第二个 vnode......最终都是更新文本的操作

最终只更新了一次文本节点</code></pre>

<hr>
<ul>
<li>更改第一个元素的值，设置 key</li>
<li>123</li>
<li>023</li>
</ul>
<pre class="language-none"><code class="language-none">如果把数组中的当前项，设置为 li 的 key 的话，第一个新的 VNode，和 第一个老的 VNode 不是 sameVnode
于是比较 最后一个新的节点和最后一个老的节点，是sameVnode，节点内容也一样什么都不做
倒数第二个节点也一样
回到比较第一个节点的过程，新的第一个节点，在老节点中找不到相同节点，
这时候创建一个新的 li，插入到第一个老的li之前。
此时新节点遍历完毕，结束循环。
最后再把老的第一个li节点，从界面上移除

只有一次插入的 DOM 操作，和一次移除的 DOM 操作</code></pre>

<hr>
<ul>
<li>翻转数组，不设置 key<ul>
<li>1  2  3   </li>
<li>3  2  1</li>
</ul>
</li>
</ul>
<pre class="language-none"><code class="language-none">不设置 key 的情况，对比 第一个旧的开始节点和新的开始节点，是 sameVnode
继续 updateChildren，更新文本节点的内容

继续往后都是相同的操作

二次更新文本的操作</code></pre>

<hr>
<ul>
<li><p>翻转数组，设置 key</p>
<ul>
<li><p>   1  2  3  </p>
</li>
<li><p>3  2  1</p>
</li>
</ul>
</li>
</ul>
<pre class="language-none"><code class="language-none">翻转数组，第一个旧节点和第一个新节点不是 sameVnode
然后比较  最后一个旧节点和最后一个新节点，不是 sameVnode，
这时候继续比较第一个旧节点和最后一个新节点，key和sel相同，因为这两个节点的内容也是一样的，所以不更新，但是要移动位置，把第一个旧节点移动到结束节点之后

继续比较第二个开始节点和倒数第二个结束节点，是 sameVnode（此前会先判断新旧开始和结束节点是否相同，都不同进入此步）
把旧开始节点移动到旧结束节点之后

然后再比较旧的开始节点（3）和新的结束节点（3），此时是 sameVnode 什么都不做。

两次移动的操作（n-1次操作）</code></pre></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>语轻星子</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://xxcijmz.top/blogs/1d7d6fc9/" title="虚拟DOM的实现原理">https://xxcijmz.top/blogs/1d7d6fc9/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/blogs/2ca750a/" rel="prev" title="Vue-Router源码解析"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Vue-Router源码解析</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/blogs/6032433a/" rel="next" title="模拟Vue.js响应式原理"><span class="post-nav-text">模拟Vue.js响应式原理</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div><div id="valine-container"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js", () => {
  const valineConfig = {"enable":true,"appId":"MnqOxUn1tp2XfaBiRJqcPNC3-MdYXbMMI","appKey":"BUJAYYUt5IhdIDVVvHH8aHMx","placeholder":"来与我一起讨论吧","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = "/blogs/1d7d6fc9/"
  new Valine(valineConfig)
}, window.Valine);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">闽ICP备2021017107号-1</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 语轻星子</span></div><div class="live_time"><span>本博客已运行：</span><span id="display_live_time"></span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-09-23T00:03:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#5698c3" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.9},"dialog":{"enable":true},"log":false});</script></body></html>